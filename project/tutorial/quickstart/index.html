
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../document/timer/">
      
      
        <link rel="next" href="../../../start/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.41">
    
    
      
        <title>第零阶段 - 2024 级问题求解（程设部分）</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i,700,700i%7CFira+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Fira Sans";--md-code-font:"Fira Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../css/heimu.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#第零阶段" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="2024 级问题求解（程设部分）" class="md-header__button md-logo" aria-label="2024 级问题求解（程设部分）" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3 1 9l11 6 9-4.91V17h2V9M5 13.18v4L12 21l7-3.82v-4L12 17z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            2024 级问题求解（程设部分）
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              第零阶段
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="red"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ps24-prog/ps-wiki" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    ps-wiki
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../.." class="md-tabs__link">
          
  
    
  
  主版

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
    
  
  项目

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../start/" class="md-tabs__link">
          
  
    
  
  指南

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../oj/" class="md-tabs__link">
          
  
    
  
  OJ

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../lab/" class="md-tabs__link">
          
  
    
  
  Lab

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="2024 级问题求解（程设部分）" class="md-nav__button md-logo" aria-label="2024 级问题求解（程设部分）" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3 1 9l11 6 9-4.91V17h2V9M5 13.18v4L12 21l7-3.82v-4L12 17z"/></svg>

    </a>
    2024 级问题求解（程设部分）
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ps24-prog/ps-wiki" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    ps-wiki
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../.." class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    主版
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            主版
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    项目
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            项目
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../document/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    文档
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            文档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../document/ui/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ui
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../document/widget/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    widget
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../document/timer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    timer
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" checked>
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    教程
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            教程
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    第零阶段
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    第零阶段
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#引入" class="md-nav__link">
    <span class="md-ellipsis">
      引入
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#准备工作" class="md-nav__link">
    <span class="md-ellipsis">
      准备工作
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#第一个-minitui-程序" class="md-nav__link">
    <span class="md-ellipsis">
      第一个 minitui 程序
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#组件--窗口系统入门" class="md-nav__link">
    <span class="md-ellipsis">
      组件 &amp; 窗口系统入门
    </span>
  </a>
  
    <nav class="md-nav" aria-label="组件 & 窗口系统入门">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#窗口树" class="md-nav__link">
    <span class="md-ellipsis">
      窗口树
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#窗口显示机制" class="md-nav__link">
    <span class="md-ellipsis">
      窗口显示机制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#窗口事件机制" class="md-nav__link">
    <span class="md-ellipsis">
      窗口事件机制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#组件类和根组件" class="md-nav__link">
    <span class="md-ellipsis">
      组件类和根组件
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#事件系统入门" class="md-nav__link">
    <span class="md-ellipsis">
      事件系统入门
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#第二个-minitui-程序增加功能" class="md-nav__link">
    <span class="md-ellipsis">
      第二个 minitui 程序：增加功能
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#第三个-minitui-程序创建组件" class="md-nav__link">
    <span class="md-ellipsis">
      第三个 minitui 程序：创建组件
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第三个 minitui 程序：创建组件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#具体组件实现方式继承" class="md-nav__link">
    <span class="md-ellipsis">
      具体组件实现方式：继承
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#具体组件归一化多态" class="md-nav__link">
    <span class="md-ellipsis">
      具体组件归一化：多态
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#组件性质也是一种归一化" class="md-nav__link">
    <span class="md-ellipsis">
      组件性质：也是一种归一化
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#本阶段任务" class="md-nav__link">
    <span class="md-ellipsis">
      本阶段任务
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#第零阶段代码任务" class="md-nav__link">
    <span class="md-ellipsis">
      第零阶段代码任务
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第零阶段代码任务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#组件代理系统入门" class="md-nav__link">
    <span class="md-ellipsis">
      组件代理系统入门
    </span>
  </a>
  
    <nav class="md-nav" aria-label="组件代理系统入门">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#从-border_proxy-的定义开始" class="md-nav__link">
    <span class="md-ellipsis">
      从 border_proxy 的定义开始
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#组件代理装饰器模式" class="md-nav__link">
    <span class="md-ellipsis">
      组件代理：装饰器模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#如何给组件套壳代理链" class="md-nav__link">
    <span class="md-ellipsis">
      如何给组件「套壳」：代理链
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#牛刀小试x-边框" class="md-nav__link">
    <span class="md-ellipsis">
      牛刀小试："X" 边框
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#代理机制下的-area-处理" class="md-nav__link">
    <span class="md-ellipsis">
      代理机制下的 area 处理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#代理功能参数机制" class="md-nav__link">
    <span class="md-ellipsis">
      代理/功能参数机制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#实例学习tui_quit_proxy" class="md-nav__link">
    <span class="md-ellipsis">
      实例学习：tui_quit_proxy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_attrs-的庐山真面目" class="md-nav__link">
    <span class="md-ellipsis">
      set_attrs 的庐山真面目
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#边框代理实现" class="md-nav__link">
    <span class="md-ellipsis">
      边框代理实现
    </span>
  </a>
  
    <nav class="md-nav" aria-label="边框代理实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#构造函数" class="md-nav__link">
    <span class="md-ellipsis">
      构造函数
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#后续任务预告--建议" class="md-nav__link">
    <span class="md-ellipsis">
      后续任务预告 &amp; 建议
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../start/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    指南
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            指南
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../start/quickstart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    快速上手
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../start/beforeps/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    写在问求之前
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../start/code-style/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    代码风格
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../start/program/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    程序设计基础
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            程序设计基础
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5_2" >
        
          
          <label class="md-nav__link" for="__nav_3_5_2" id="__nav_3_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    C++ 基础
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_2">
            <span class="md-nav__icon md-icon"></span>
            C++ 基础
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/helloworld/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hello, World!
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/basic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    C++ 语法基础
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/var/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    变量
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/op/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    运算
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5_2_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5_2_5" id="__nav_3_5_2_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    流程控制语句
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_5_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_2_5">
            <span class="md-nav__icon md-icon"></span>
            流程控制语句
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/branch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    分支
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/loop/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    循环
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5_2_6" >
        
          
          <label class="md-nav__link" for="__nav_3_5_2_6" id="__nav_3_5_2_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    高级数据类型
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_5_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_2_6">
            <span class="md-nav__icon md-icon"></span>
            高级数据类型
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/array/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    数组
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/struct/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    结构体
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/union/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    联合体
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/pointer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    指针
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/func/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    函数
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/file-op/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    文件操作
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../lang/csl/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    C++ 标准库
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_5_3" id="__nav_3_5_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_3">
            <span class="md-nav__icon md-icon"></span>
            C++ 标准库
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_5_3_2" id="__nav_3_5_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    STL 容器
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_5_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_3_2">
            <span class="md-nav__icon md-icon"></span>
            STL 容器
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/csl/container/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    STL 容器简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/csl/iterator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    迭代器
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/csl/sequence-container/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    序列式容器
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/csl/associative-container/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    关联式容器
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/csl/unordered-container/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    无序关联式容器
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/csl/container-adapter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    容器适配器
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/csl/algorithm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    STL 算法
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/csl/bitset/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bitset
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/csl/string/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    string
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/csl/pair/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pair
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5_4" >
        
          
          <label class="md-nav__link" for="__nav_3_5_4" id="__nav_3_5_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    C++ 进阶
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_4">
            <span class="md-nav__icon md-icon"></span>
            C++ 进阶
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/class/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    类
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/namespace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    命名空间
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/value-category/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    值类别
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/op-overload/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    重载运算符
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    引用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/const/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    常值
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/new/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    新版 C++ 特性
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/lambda/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lambda 表达式
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/optimizations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    编译优化
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/cpp-other-langs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    C++ 与其他常用语言的区别
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../start/theory/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    理论环境配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../start/learn-more/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    资源聚集处
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../oj/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    OJ
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            OJ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../oj/ps1/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    第一学期
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            第一学期
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2_2" id="__nav_4_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    1-0
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_2">
            <span class="md-nav__icon md-icon"></span>
            1-0
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../oj/ps1/1-0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    讲义
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_3" >
        
          
          <label class="md-nav__link" for="__nav_4_2_3" id="__nav_4_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    1-1
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_3">
            <span class="md-nav__icon md-icon"></span>
            1-1
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../oj/ps1/1-1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    讲义
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../oj/ps1/1-1-sol/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    题解
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_4" >
        
          
          <label class="md-nav__link" for="__nav_4_2_4" id="__nav_4_2_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    1-2
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_4">
            <span class="md-nav__icon md-icon"></span>
            1-2
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../oj/ps1/1-2-sol/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    题解
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_5" >
        
          
          <label class="md-nav__link" for="__nav_4_2_5" id="__nav_4_2_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    1-3
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_5">
            <span class="md-nav__icon md-icon"></span>
            1-3
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../oj/ps1/1-3-sol/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    题解
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../lab/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Lab
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Lab
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#引入" class="md-nav__link">
    <span class="md-ellipsis">
      引入
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#准备工作" class="md-nav__link">
    <span class="md-ellipsis">
      准备工作
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#第一个-minitui-程序" class="md-nav__link">
    <span class="md-ellipsis">
      第一个 minitui 程序
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#组件--窗口系统入门" class="md-nav__link">
    <span class="md-ellipsis">
      组件 &amp; 窗口系统入门
    </span>
  </a>
  
    <nav class="md-nav" aria-label="组件 & 窗口系统入门">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#窗口树" class="md-nav__link">
    <span class="md-ellipsis">
      窗口树
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#窗口显示机制" class="md-nav__link">
    <span class="md-ellipsis">
      窗口显示机制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#窗口事件机制" class="md-nav__link">
    <span class="md-ellipsis">
      窗口事件机制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#组件类和根组件" class="md-nav__link">
    <span class="md-ellipsis">
      组件类和根组件
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#事件系统入门" class="md-nav__link">
    <span class="md-ellipsis">
      事件系统入门
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#第二个-minitui-程序增加功能" class="md-nav__link">
    <span class="md-ellipsis">
      第二个 minitui 程序：增加功能
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#第三个-minitui-程序创建组件" class="md-nav__link">
    <span class="md-ellipsis">
      第三个 minitui 程序：创建组件
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第三个 minitui 程序：创建组件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#具体组件实现方式继承" class="md-nav__link">
    <span class="md-ellipsis">
      具体组件实现方式：继承
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#具体组件归一化多态" class="md-nav__link">
    <span class="md-ellipsis">
      具体组件归一化：多态
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#组件性质也是一种归一化" class="md-nav__link">
    <span class="md-ellipsis">
      组件性质：也是一种归一化
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#本阶段任务" class="md-nav__link">
    <span class="md-ellipsis">
      本阶段任务
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#第零阶段代码任务" class="md-nav__link">
    <span class="md-ellipsis">
      第零阶段代码任务
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第零阶段代码任务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#组件代理系统入门" class="md-nav__link">
    <span class="md-ellipsis">
      组件代理系统入门
    </span>
  </a>
  
    <nav class="md-nav" aria-label="组件代理系统入门">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#从-border_proxy-的定义开始" class="md-nav__link">
    <span class="md-ellipsis">
      从 border_proxy 的定义开始
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#组件代理装饰器模式" class="md-nav__link">
    <span class="md-ellipsis">
      组件代理：装饰器模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#如何给组件套壳代理链" class="md-nav__link">
    <span class="md-ellipsis">
      如何给组件「套壳」：代理链
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#牛刀小试x-边框" class="md-nav__link">
    <span class="md-ellipsis">
      牛刀小试："X" 边框
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#代理机制下的-area-处理" class="md-nav__link">
    <span class="md-ellipsis">
      代理机制下的 area 处理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#代理功能参数机制" class="md-nav__link">
    <span class="md-ellipsis">
      代理/功能参数机制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#实例学习tui_quit_proxy" class="md-nav__link">
    <span class="md-ellipsis">
      实例学习：tui_quit_proxy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_attrs-的庐山真面目" class="md-nav__link">
    <span class="md-ellipsis">
      set_attrs 的庐山真面目
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#边框代理实现" class="md-nav__link">
    <span class="md-ellipsis">
      边框代理实现
    </span>
  </a>
  
    <nav class="md-nav" aria-label="边框代理实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#构造函数" class="md-nav__link">
    <span class="md-ellipsis">
      构造函数
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#后续任务预告--建议" class="md-nav__link">
    <span class="md-ellipsis">
      后续任务预告 &amp; 建议
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="第零阶段">第零阶段<a class="headerlink" href="#第零阶段" title="Permanent link">&para;</a></h1>
<h2 id="引入">引入<a class="headerlink" href="#引入" title="Permanent link">&para;</a></h2>
<p>我们的大作业使用的是一款名为 minitui 的教学用 TUI 框架。</p>
<p>相比普通的教学用控制台项目，minitui 界面美观，交互友好，功能强大。</p>
<p>同时，它还更接近一个「真实的」工程项目，设计更加完善和模块化，可维护性和可拓展性较好。</p>
<details class="tip">
<summary>具体来说……</summary>
<ul>
<li><strong>界面美观</strong>：<ul>
<li>基于 ANSI 转义序列支持的真彩色（1677 万色）显示，五彩斑斓。</li>
<li>基于 Unicode 绘制的方形像素，边框等组件，质感真实。</li>
</ul>
</li>
<li><strong>交互友好</strong>：<ul>
<li>异步/非阻塞的用户 I/O，且基于时钟事件可实现计时器/回调功能。</li>
<li>基于 ANSI 转义序列，可实现鼠标事件的获取。</li>
</ul>
</li>
<li><strong>功能强大</strong>：<ul>
<li>具备组件系统，可实现多窗口 &amp; 窗口管理 &amp; 窗口框架等种种 GUI 特性，可以模拟真实的 GUI 体验。</li>
<li>结合事件系统 &amp; 绘制系统，组件可具有真彩画布和强大交互能力，能够渲染多媒体内容 &amp; 游戏。</li>
</ul>
</li>
<li><strong>工程设计</strong><ul>
<li>有限使用了 C++ 的面向对象设计/泛型特性，在保持语法简单的同时保证复用性/拓展性，降低开发难度。</li>
<li>基于装饰器机制的组件 proxy 设置，能够动态为组件添加性质（装饰器）。</li>
<li>未来还将推出不需重新编译的动态加载组件机制，可实现基于布局文件 &amp; DLL 文件创建组件或窗口框架。</li>
<li><del>单元测试（待加入）</del></li>
</ul>
</li>
</ul>
</details>
<p>我们的目的是使得大家能够通过在这一框架上进行大作业开发：</p>
<ul>
<li>锻炼代码能力：设计可用代码的能力，阅读他人代码的能力，产出可读代码的能力。</li>
<li>锻炼工程能力：学习小型项目的设计方法和开发流程，包括使用 git 进行项目管理等。</li>
<li>培养兴趣：通过独立开发一个好看且新颖的程序收获成就感。</li>
</ul>
<!-- 单元测试？ -->

<table>
<thead>
<tr>
<th style="text-align: center;"><img alt="" src="../../../pics/proj-conventional-project.png" /></th>
<th style="text-align: center;"><img src="../../../pics/proj-minitui-project.png" style="zoom:58%;" /></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">传统的教学控制台项目 demo</td>
<td style="text-align: center;">使用 minitui 框架的项目 demo</td>
</tr>
</tbody>
</table>
<p>接下来我们就看看如何在 minitui 上进行开发吧！</p>
<h2 id="准备工作">准备工作<a class="headerlink" href="#准备工作" title="Permanent link">&para;</a></h2>
<p>首先先从 github 拉取<a href="https://github.com/ps24-prog/project1/tree/phase0">第零阶段代码</a>。</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>-b<span class="w"> </span>phase0<span class="w"> </span>https://github.com/ps24-prog/project1
</code></pre></div>
<p>按照 <code>readme.md</code> 的指示配置好环境并在 <code>make -j8 shell</code> 以后执行 <code>game</code> 运行 demo。</p>
<h2 id="第一个-minitui-程序">第一个 minitui 程序<a class="headerlink" href="#第一个-minitui-程序" title="Permanent link">&para;</a></h2>
<p>拉取代码，跑完 demo 以后就可以开始撰写第一个 minitui 程序了。</p>
<p>将 <code>Makefile</code> 的 <code>STAGE</code> 变量改成 <code>test/phase0</code>，然后执行 <code>make clean</code>。</p>
<p>在 <code>test/phase0/source/main.cpp</code> 中写入如下内容：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// minitui.h 中包含了 C++ 常用库和所有 minitui 提供的对象 &amp; 接口</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;minitui.h&gt;</span>

<span class="c1">// 程序主函数，需要接受命令行提供的参数</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="c1">// 调用 minitui 的初始化接口处理命令行参数并进行必要的初始化</span>
<span class="w">  </span><span class="n">tui_init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 设置你喜欢的窗口标题</span>
<span class="w">  </span><span class="n">ansi_title</span><span class="p">(</span><span class="s">&quot;NJU Universalis&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 启动主事件循环</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ret_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tui_exec</span><span class="p">();</span>
<span class="w">  </span><span class="c1">// 处理异常返回值</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret_value</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="n">Warn</span><span class="p">(</span><span class="s">&quot;tui_exec() returns with a non-zero value %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ret_value</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">ret_value</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>执行 <code>make -j8 shell</code>，进入游戏启动器后输入 <code>game</code> 回车。</p>
<p>如果一切正常，你会看见一个黑洞洞的窗口，该窗口会在你按下 Ctrl+C 时退出。</p>
<p>OK，这就是我们创建的第一个可运行的 minitui 程序。</p>
<p>虽然无聊，但是我们此时可以借机介绍一些 minitui 机制——为什么按下 Ctrl + C 时会退出？怎么进行进一步开发？</p>
<h2 id="组件--窗口系统入门">组件 &amp; 窗口系统入门<a class="headerlink" href="#组件--窗口系统入门" title="Permanent link">&para;</a></h2>
<p>和大部分 GUI 框架一样，组件（<code>tui_widget</code>）是 minitui 的核心概念。</p>
<div class="admonition question">
<p class="admonition-title">为什么是和 <em>GUI</em> 框架一样？</p>
<p>因为 minitui 的目的其实就是在终端上实现一个简易 GUI。</p>
<p>继续看下去你会发现，我们总是在借鉴/模仿/实现 GUI 的概念。</p>
</div>
<p>通俗来讲，组件就是屏幕上<em>某个位置</em>一块<em>看得见</em>，<em>能操作</em>的东西。</p>
<p>形式化地说，作为和用户交互和显示的基本单元，组件的三大核心特点/功能是：</p>
<ul>
<li>占据一定区域。</li>
<li>具有特定可绘制内容。</li>
<li>能够响应事件并作出变化。</li>
</ul>
<p>和组件密切相关的概念是<strong>窗口</strong>。</p>
<p>在 minitui 中，组件最终都要以窗口的形式呈现，任何窗口本身也是一个组件。</p>
<p>在这里，我们先认为所有组件都是窗口组件，后面我们会接触到非窗口组件。</p>
<h3 id="窗口树">窗口树<a class="headerlink" href="#窗口树" title="Permanent link">&para;</a></h3>
<p>窗口有父子关系，所有窗口之间的父子关系形成一棵树，并且有一个唯一的根。</p>
<p>每个窗口都可以创建子窗口，并且在其子窗口退出时会特殊通知——类似一种特殊的事件响应。</p>
<h3 id="窗口显示机制">窗口显示机制<a class="headerlink" href="#窗口显示机制" title="Permanent link">&para;</a></h3>
<p>为了显示出窗口，我们需要将窗口注册到窗口管理器中（通过 <code>tui_reg_widget()</code>），后者会根据窗口的区域和覆盖关系（如何维护我们之后再谈），通过调用组件绘制接口绘制整个屏幕。</p>
<p>当然啦，我们知道屏幕是一个由字符格构成的二维画布，而窗口区域也是这样的二维矩形，全局和窗口绘制都是以字符格为单位的。</p>
<p>讲到这点，是因为要说明当我们后续在绘制时提到「位置」就是指一个（离散的）字符格坐标，「区域」就是指两个这样的坐标确定的一个字符格矩形——可以参考 <code>geometry</code> 模块的定义。</p>
<h3 id="窗口事件机制">窗口事件机制<a class="headerlink" href="#窗口事件机制" title="Permanent link">&para;</a></h3>
<p>为了和用户交互，事件循环会在接受到事件时：</p>
<ul>
<li>如果是特殊事件，特殊处理。</li>
<li>如果不是，交给目前的焦点窗口处理，如果返回了新事件或者窗口退出 - 就交给其父窗口处理，直到没有父窗口或者没有了事件为止。</li>
</ul>
<h3 id="组件类和根组件">组件类和根组件<a class="headerlink" href="#组件类和根组件" title="Permanent link">&para;</a></h3>
<p>可以看到，围绕着组件和窗口这两个 GUI 的基础概念，我们已经有了一个事件/绘制系统的雏形。</p>
<p>不过现在还是让我们关注组件系统吧。
在对整个组件系统及其对接系统有了基本概念以后，我们就可以看懂 <code>tui_widget</code> 的主要属性和接口了：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:1"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">widget.h</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">tui_widget</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span><span class="w">                            </span><span class="c1">// 组件名称</span>
<span class="w">  </span><span class="n">tui_rect</span><span class="w"> </span><span class="n">area</span><span class="p">;</span><span class="w">                            </span><span class="c1">// 在屏幕上占据的区域</span>
<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">;</span><span class="w">                       </span><span class="c1">// 父窗口</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">instaniated</span><span class="p">;</span><span class="w">                         </span><span class="c1">// 是否作为窗口被注册</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">children</span><span class="p">;</span><span class="w">       </span><span class="c1">// 孩子们</span>

<span class="w">  </span><span class="c1">// 构造函数</span>
<span class="w">  </span><span class="n">tui_widget</span><span class="p">(</span><span class="n">tui_rect</span><span class="w"> </span><span class="n">area</span><span class="o">=</span><span class="n">global_rect</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="o">=</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="o">=</span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 增加一个子窗口，并将它注册到窗口管理器中</span>
<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="nf">create_widget</span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">widget</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// 增加一个子窗口</span>
<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="nf">add_widget</span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">widget</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 响应事件：输入一个事件，返回另一个事件</span>
<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="nf">on_event</span><span class="p">(</span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// 绘图：绘制给定的位置（注意是相对的）</span>
<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="w">  </span><span class="c1">// 特殊的事件：子窗口的退出</span>
<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="nf">on_child_exit</span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">child</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
</div>
</div>
</div>
<details class="question" open="open">
<summary>什么是类？什么是组件类？</summary>
<p>我假定大家有基本的面向对象常识（补习班讲过了）。</p>
<p>不过这里还是再提一嘴：</p>
<p>类是一种自定义数据类型，我们把用这些类型定义的变量叫做<strong>对象</strong>，对象具有其类定义的<strong>属性</strong>和<strong>方法</strong>。</p>
<p>组件类定义了所有组件对象共有的属性/方法，使得属于组件类的对象（<strong>实例</strong>）都具有一些相同的交互方式。</p>
<p>本文可能会混用<em>接口</em>和方法。具体原因在此展开就有点长了，暂且不表。</p>
</details>
<p>我们看到的那个「黑洞洞」的画面，其上其实是有一个窗口/组件的，即 <code>root</code>。</p>
<p>根组件在全局都可访问，并在 <code>tui_widget_init()</code> 中初始化：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:1"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">widget.cpp</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1">// 全局指针，指向当前的窗口树的根</span>
<span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">root</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">tui_widget_init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">                </span><span class="c1">// 在 `tui_init()` 中被调用</span>
<span class="w">  </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tui_widget</span><span class="p">(</span><span class="n">global_rect</span><span class="p">);</span><span class="w">   </span><span class="c1">// 覆盖整个屏幕</span>
<span class="w">  </span><span class="n">strcpy</span><span class="p">(</span><span class="n">root</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ROOT&quot;</span><span class="p">);</span><span class="w">           </span><span class="c1">// 设置名字</span>
<span class="w">  </span><span class="n">root</span><span class="o">-&gt;</span><span class="n">reset_block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w">             </span><span class="c1">// 置于最底层，不可获取焦点</span>
<span class="w">  </span><span class="n">tui_reg_widget</span><span class="p">(</span><span class="n">root</span><span class="p">);</span><span class="w">                 </span><span class="c1">// 将组件注册到窗口管理器中显示出来</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<p>之所以叫它根组件，是因为它是唯一是窗口而 <code>parent</code> 为 <code>NULL</code> 的组件，也即是窗口树的根。</p>
<p>接下来让我们看看根组件的实现（它就是一个 widget 类的实例）：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:1"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">widget.cpp</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1">// event blackhole</span>
<span class="n">tui_event</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_widget::on_event</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Warn</span><span class="p">(</span><span class="s">&quot;A NULL event given!&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">delete</span><span class="w"> </span><span class="n">event</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// void</span>
<span class="kt">void</span>
<span class="nf">tui_widget::draw</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span>
<span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">putchar</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<p>OK，非常的朴实无华：</p>
<p>事件：它对任何事件都不作响应且直接返回空。</p>
<p>绘制：它在区域内任何位置都输出空格。</p>
<h2 id="事件系统入门">事件系统入门<a class="headerlink" href="#事件系统入门" title="Permanent link">&para;</a></h2>
<p>现在我们还需要解决一个问题：为什么按 <code>Ctrl + C</code> 会退出呢？</p>
<p>这就要介绍我们的事件系统了。</p>
<p>其实，「事件系统」四个字听起来比较高大上，其实其主体部分也就是响应用户的键鼠输入罢了。</p>
<p>而对于终端（仿真器）来讲，键盘和鼠标输入都会被处理后送入 <code>stdin</code> 标准输入，并能被 <code>getchar()</code> 之类的接口获取。</p>
<p><code>tui_terminal_init()</code> 会把终端调教成一个能够按照特定形式翻译键鼠输入的模式，可以参考 <a href="https://invisible-island.net/xterm/ctlseqs/ctlseqs.html#h3-Button-event-tracking">ctlseqs</a> ，不过我们现在不需要关心细节，只需要知道键鼠事件都能被以字符为单位获取就行了。</p>
<p>特别是键盘事件，大部分键盘事件都直接被翻译为对应的 ASCII 码表示的单个字符。</p>
<p>——就比如 <code>Ctrl + C</code>，它被翻译为 <code>\x3</code>。</p>
<p>特殊事件一般以 <code>ESC</code> 字符开头，我们这里就不细究其处理。</p>
<p>当然，我们还需要有一个描述事件的数据结构，一个简单的方案是拆成事件类型和事件体。</p>
<p>事件体可以有不同的类型——统一用一个 <code>void *</code> 指针来表示，需要用到的时候再进行转换。</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:1"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">event.h</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="k">enum</span><span class="w"> </span><span class="nc">tui_event_type</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">TUI_NO_EVENT</span><span class="p">,</span>
<span class="w">  </span><span class="n">TUI_KEYBD_EVENT</span><span class="p">,</span>
<span class="w">  </span><span class="n">TUI_MOUSE_EVENT</span><span class="p">,</span>
<span class="w">  </span><span class="n">TUI_TIMER_INTERUPTER_EVENT</span><span class="p">,</span><span class="w"> </span><span class="c1">// no body</span>
<span class="w">  </span><span class="n">TUI_EXIT_EVENT</span><span class="p">,</span>
<span class="w">  </span><span class="n">TUI_PASTE_EVENT</span>
<span class="p">};</span>

<span class="c1">// 各种事件类型，可以具体查看格式</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">tui_mouse_event</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">tui_paste_event</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">tui_kbd_event</span><span class="p">;</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">tui_exit_event</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">tui_event</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">event_type</span><span class="p">;</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">event_body</span><span class="p">;</span>

<span class="w">  </span><span class="n">tui_event</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">event_type</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">event_body</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">event_type</span><span class="p">(</span><span class="n">event_type</span><span class="p">)</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">event_body</span><span class="p">(</span><span class="n">event_body</span><span class="p">)</span>
<span class="w">  </span><span class="p">{}</span>
<span class="p">};</span>
</code></pre></div>
</div>
</div>
</div>
<p>想要构造一个新的事件，只需创建一个 <code>tui_event</code>，指定其类型和事件体即可。</p>
<p>结合上文所述，获取事件的函数就容易读懂了：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:1"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">event.cpp</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_get_event</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tui_getchar</span><span class="p">();</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ESC 特殊事件</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="no">ESC_CODE</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">tui_get_ansi_event</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// ^C 退出</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;\x3&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tui_event</span><span class="p">(</span>
<span class="w">      </span><span class="n">TUI_EXIT_EVENT</span><span class="p">,</span><span class="w"> </span>
<span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="n">tui_exit_event</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// 其他</span>
<span class="w">  </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Debug</span><span class="p">(</span><span class="s">&quot;Get a key %d!&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ch</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tui_event</span><span class="p">(</span>
<span class="w">      </span><span class="n">TUI_KEYBD_EVENT</span><span class="p">,</span><span class="w"> </span>
<span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="n">tui_kbd_event</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<p>因此，<code>Ctrl + C</code> 会退出是因为其会生成一个特殊的 <code>TUI_EXIT_EVENT</code> 事件。</p>
<p>事件循环获取到该特殊事件后，就不经组件处理，直接结束整个事件循环了。</p>
<details class="question" open="open">
<summary>为什么总是用 <code>new</code>？</summary>
<p><code>new</code> 会把对象创建在堆上，并返回指向该对象的指针。
<br/>——这意味着对象是全局且持久的，不会因为离开作用域而被销毁。</p>
<p>在 minitui 中，事件，组件等对象都是需要跨作用域传递的且不能被轻易复制的。</p>
<p>因此，需要用 <code>new</code> 来创建唯一全局的实例，并用指针来引用它们。</p>
</details>
<h2 id="第二个-minitui-程序增加功能">第二个 minitui 程序：增加功能<a class="headerlink" href="#第二个-minitui-程序增加功能" title="Permanent link">&para;</a></h2>
<p>现在我们已经知道，在第一个程序中已经存在有 <code>root</code> 组件，现在让我们为它添加一些功能。</p>
<p>把代码改成这样：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// minitui.h 中包含了 C++ 常用库和所有 minitui 提供的对象 &amp; 接口</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;minitui.h&gt;</span>

<span class="c1">// 程序主函数，需要接受命令行提供的参数</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="c1">// 调用 minitui 的初始化接口处理命令行参数并进行必要的初始化</span>
<span class="w">  </span><span class="n">tui_init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 设置你喜欢的窗口标题</span>
<span class="w">  </span><span class="n">ansi_title</span><span class="p">(</span><span class="s">&quot;NJU Universalis&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 给根组件添加功能</span>
<span class="w">  </span><span class="n">root</span><span class="o">-&gt;</span><span class="n">set_attrs</span><span class="p">(</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;border shrink&quot;</span><span class="p">,</span><span class="w">          </span><span class="c1">// 具备有边框</span>
<span class="w">      </span><span class="s">&quot;title&quot;</span><span class="p">,</span><span class="w">                  </span><span class="c1">// 具备有标题</span>
<span class="w">      </span><span class="n">tui_fmt</span><span class="p">(</span><span class="s">&quot;quit %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;q&#39;</span><span class="p">)</span><span class="w">   </span><span class="c1">// 按 q 退出</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 启动主事件循环</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ret_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tui_exec</span><span class="p">();</span>
<span class="w">  </span><span class="c1">// 处理异常返回值</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret_value</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="n">Warn</span><span class="p">(</span><span class="s">&quot;tui_exec() returns with a non-zero value %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ret_value</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">ret_value</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>然后在刚刚的 shell 里执行 <code>compile</code> 命令后再执行 <code>game</code> 命令。</p>
<p>（如果你不慎退出了，再 <code>make shell</code> 即可）</p>
<!-- todo implemnt shrinkable border area there -->
<p>现在你会发现 ROOT 组件有了标题和边框，并会在按 q 时退出。</p>
<p>这是怎么做到的呢？我们在这里先不介绍。</p>
<p>只需要记住组件对象的这一方法：<code>set_attrs()</code>。</p>
<p>它接受一个性质字符串 <code>vector</code>，并能够将这些性质（功能）加到组件上。</p>
<p>注：<code>tui_fmt</code> 是一个 <code>sprintf</code> 的封装，能够将其结果字符串直接包装起来，类似字符串类型。</p>
<h2 id="第三个-minitui-程序创建组件">第三个 minitui 程序：创建组件<a class="headerlink" href="#第三个-minitui-程序创建组件" title="Permanent link">&para;</a></h2>
<p>在大部分情况下，root 组件是不需要处理事件的，它就是一个方便处理窗口树的背景板。</p>
<p>root 组件的实现使得它会在所有其他窗口退出时退出：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:1"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">widget.cpp</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_widget::on_child_exit</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">child</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// if not root, do nothing</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">root</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">children</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">child</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tui_event</span><span class="p">(</span>
<span class="w">      </span><span class="n">TUI_EXIT_EVENT</span><span class="p">,</span>
<span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="n">tui_exit_event</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">retcode</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<p>我们利用 <code>create_widget</code> 接口新建两个 root 的子窗口，并注册到窗口管理器上显示出来：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;minitui.h&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="n">tui_init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
<span class="w">  </span><span class="n">ansi_title</span><span class="p">(</span><span class="s">&quot;NJU Universalis&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="n">root</span><span class="o">-&gt;</span><span class="n">set_attrs</span><span class="p">(</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;border shrink&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;title&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 组件：文本框</span>
<span class="w">  </span><span class="n">root</span><span class="o">-&gt;</span><span class="n">create_widget</span><span class="p">(</span>
<span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">tui_textbox</span><span class="p">(</span>
<span class="w">      </span><span class="n">tui_rect</span><span class="p">(</span>
<span class="w">        </span><span class="n">global_rect</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">        </span><span class="n">global_rect</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="n">global_rect</span><span class="p">.</span><span class="n">height</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">global_rect</span><span class="p">.</span><span class="n">width</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="w">      </span><span class="p">),</span>
<span class="w">      </span><span class="s">&quot;storage/Hello.txt&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="n">tui_formatter</span><span class="p">()</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_attrs</span><span class="p">(</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;border&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;title&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="n">tui_fmt</span><span class="p">(</span><span class="s">&quot;quit %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;q&#39;</span><span class="p">),</span>
<span class="w">      </span><span class="s">&quot;kbd_move&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="c1">// 组件：色阶画布</span>
<span class="w">  </span><span class="n">root</span><span class="o">-&gt;</span><span class="n">create_widget</span><span class="p">(</span>
<span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">tui_ncanvas</span><span class="p">(</span>
<span class="w">      </span><span class="n">tui_rect</span><span class="p">(</span>
<span class="w">        </span><span class="n">global_rect</span><span class="p">.</span><span class="n">tail</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="n">global_rect</span><span class="p">.</span><span class="n">height</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">),</span>
<span class="w">        </span><span class="n">global_rect</span><span class="p">.</span><span class="n">tail</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span><span class="o">-&gt;</span><span class="n">set_attrs</span><span class="p">(</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;border&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;title&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="n">tui_fmt</span><span class="p">(</span><span class="s">&quot;quit %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;q&#39;</span><span class="p">),</span>
<span class="w">      </span><span class="s">&quot;kbd_move&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">);</span>


<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ret_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tui_exec</span><span class="p">();</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret_value</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="n">Warn</span><span class="p">(</span><span class="s">&quot;tui_exec() returns with a non-zero value %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ret_value</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">ret_value</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>虽然我们介绍过 <code>create_widget()</code>，但对于里面的内容，你可能完全不了解。</p>
<p>别着急，接下来我们来仔细介绍一下。</p>
<h3 id="具体组件实现方式继承">具体组件实现方式：继承<a class="headerlink" href="#具体组件实现方式继承" title="Permanent link">&para;</a></h3>
<p>我们知道 <code>create_widget(widget)</code> 的功能是把 <code>widget</code> 作为子窗口注册到窗口管理器上。</p>
<p>但是我们写的代码里用的明明是 <code>tui_ncanvas</code> 和 <code>tui_textbox</code> 啊。</p>
<p>它们是怎么实现的？又是怎么能够被转化为 <code>tui_widget</code> 类型的指针？</p>
<p>这就涉及到面向对象编程中重要的概念：继承。</p>
<p><code>tui_widget</code> 作为组件类，定义了每个组件对象需要具有的基本属性和接口（见上文）。</p>
<p>但是，我们看到 <code>tui_widget</code> 的对于 <code>on_event()</code> 和 <code>draw()</code> 只有一个最基本实现。</p>
<p>这个基本实现显然是不能满足需求的（显然不是所有组件都和根组件一样是黑洞洞的）。</p>
<p>因此，如果需要实现一个新的组件类型，也许我们需要仿照 <code>tui_widget</code> 实现一个新的类，想想就复杂。然而，好消息是我们不需要从头写起。</p>
<p>C++ 提供了继承机制，我们只需要创建一个新类，令它继承自 <code>tui_widget</code> 即可，继承它的类会自动获得它的所有属性和方法（当然，构造函数除外），还可以定义额外的属性和方法：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="7:1"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="__tabbed_7_1">tui_ncanvas.h</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">tui_ncanvas</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">tui_widget</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">boff</span><span class="p">;</span>

<span class="w">  </span><span class="n">tui_ncanvas</span><span class="p">(</span><span class="n">tui_rect</span><span class="w"> </span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="o">=</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">tui_ncanvas</span><span class="p">();</span>

<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="nf">on_event</span><span class="p">(</span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">);</span>
<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
</div>
</div>
</div>
<p>这样，我们就得到了 <code>tui_widget</code> 的一个<strong>派生类</strong>，此时把 <code>tui_widget</code> 称作<strong>基类</strong>。</p>
<p>上面说过派生类继承基类的所有属性和方法，但同时，我们也可以<strong>重载</strong>基类的方法。</p>
<p>重载也就是在派生类定义一个和基类某方法相同的方法，然后重新再写一个。</p>
<p><strong>重载使得派生类实例可以在相同的接口上与基类实例有不同的行为，这是继承的主要意义。</strong></p>
<p><code>tui_ncanvas</code> 重载了 <code>on_event</code> 和 <code>draw</code> 方法，使得它和基类 <code>tui_widget</code> 有不同的行为：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="8:1"><input checked="checked" id="__tabbed_8_1" name="__tabbed_8" type="radio" /><div class="tabbed-labels"><label for="__tabbed_8_1">tui_ncanvas.cpp</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kt">void</span>
<span class="nf">tui_ncanvas::draw</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span>
<span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">fr</span><span class="p">,</span><span class="w"> </span><span class="n">fg</span><span class="p">,</span><span class="w"> </span><span class="n">fb</span><span class="p">,</span><span class="w"> </span><span class="n">br</span><span class="p">,</span><span class="w"> </span><span class="n">bg</span><span class="p">,</span><span class="w"> </span><span class="n">bb</span><span class="p">;</span>
<span class="w">  </span><span class="c1">// 渐变色，从左上到右下的图谱</span>
<span class="w">  </span><span class="n">fr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">area</span><span class="p">.</span><span class="n">height</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">boff</span><span class="p">;</span>
<span class="w">  </span><span class="n">fg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="n">fb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">area</span><span class="p">.</span><span class="n">width</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">boff</span><span class="p">;</span>
<span class="w">  </span><span class="n">br</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">area</span><span class="p">.</span><span class="n">height</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">boff</span><span class="p">;</span>
<span class="w">  </span><span class="n">bg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="n">bb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">area</span><span class="p">.</span><span class="n">width</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">boff</span><span class="p">;</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">formatter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tui_formatter</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span><span class="w"> </span><span class="n">fg</span><span class="p">,</span><span class="w"> </span><span class="n">fb</span><span class="p">,</span><span class="w"> </span><span class="n">br</span><span class="p">,</span><span class="w"> </span><span class="n">bg</span><span class="p">,</span><span class="w"> </span><span class="n">bb</span><span class="p">);</span>

<span class="w">  </span><span class="n">formatter</span><span class="p">.</span><span class="n">set</span><span class="p">();</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="n">half_block</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">tui_event</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_ncanvas::on_event</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Debug</span><span class="p">(</span><span class="s">&quot;Triggered event on ncanvas&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">event_body</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Error</span><span class="p">(</span><span class="s">&quot;Invalid event given!&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">check_key</span><span class="p">(</span><span class="sc">&#39;i&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">boff</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<span class="w">    </span><span class="n">set_updated</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">event_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TUI_MOUSE_EVENT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">mouse_event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tui_mouse_event</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">event</span><span class="o">-&gt;</span><span class="n">event_body</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// this-&gt;area.log_rect();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">mouse_event</span><span class="o">-&gt;</span><span class="n">get_point</span><span class="p">().</span><span class="n">is_in</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">))</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">event</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mouse_event</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MOUSE_LEFT_CLICK</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mouse_event</span><span class="o">-&gt;</span><span class="n">ispress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">boff</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<span class="w">      </span><span class="n">set_updated</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mouse_event</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MOUSE_RIGHT_CLICK</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mouse_event</span><span class="o">-&gt;</span><span class="n">ispress</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">boff</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<span class="w">      </span><span class="n">set_updated</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">delete</span><span class="w"> </span><span class="n">event</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<p>概括来说，它额外有一个 <code>boff</code> 成员，根据其值来决定它自己区域中每一位置的颜色（<code>draw</code>），并在特定事件时改变 <code>boff</code> 的值（<code>on_event</code>）。</p>
<p><code>tui_ncanvas</code> 以及 <code>tui_textbox</code> 的实现交由你自己试着读懂，这不是我们叙述的重点。</p>
<h3 id="具体组件归一化多态">具体组件归一化：多态<a class="headerlink" href="#具体组件归一化多态" title="Permanent link">&para;</a></h3>
<p>在 minitui 中，我们使用继承主要是为了让创建能在相同接口如 <code>on_event</code> 和 <code>draw</code> 等上有不同行为（这也使得它们成为了不同类型的组件）的派生组件（具体组件）对象。</p>
<p>但除了重载它们的接口时，我们通常不关心它们的具体类型，而都想统一调用它们的同名接口（比如事件系统，绘图系统等使用组件指针，并不需要关心 <code>on_event</code>，<code>draw</code> 的具体实现）。</p>
<p>因此我们利用 C++ 实现的<strong>多态</strong>特性，把它们的指针都当作 <code>tui_widget *</code> 处理。</p>
<p>对于所有这些有共同基类的派生类对象，C++ 保证（在虚函数的前提下，这里不多介绍）能够只用基类指针的引用派生类对象，就可以调用重载后的派生类同名接口。</p>
<p>到这里，继承+多态的组合拳帮助我们实现了两件事：</p>
<ul>
<li>继承使得我们可以重载基类的接口，能够创建在相同接口下表现和基类实例不一样的派生类实例。这让我们能够创造不同的具体组件类。</li>
<li>多态使得这些不同的具体组件类在被其它系统处理时能够被当作同一类型（即 <code>tui_widget</code>）处理。这种归一化大大简化了代码逻辑。</li>
</ul>
<h3 id="组件性质也是一种归一化">组件性质：也是一种归一化<a class="headerlink" href="#组件性质也是一种归一化" title="Permanent link">&para;</a></h3>
<p>回到正题，继续关注创建的两个新组件。</p>
<div class="tabbed-set tabbed-alternate" data-tabs="9:1"><input checked="checked" id="__tabbed_9_1" name="__tabbed_9" type="radio" /><div class="tabbed-labels"><label for="__tabbed_9_1">main.cpp</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="c1">// 组件：文本框</span>
<span class="n">root</span><span class="o">-&gt;</span><span class="n">create_widget</span><span class="p">(</span>
<span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="n">tui_textbox</span><span class="p">(</span>
<span class="w">    </span><span class="n">tui_rect</span><span class="p">(</span>
<span class="w">      </span><span class="n">global_rect</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">      </span><span class="n">global_rect</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="n">global_rect</span><span class="p">.</span><span class="n">height</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">global_rect</span><span class="p">.</span><span class="n">width</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="w">    </span><span class="p">),</span>
<span class="w">    </span><span class="s">&quot;storage/Hello.txt&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">tui_formatter</span><span class="p">()</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">)</span><span class="o">-&gt;</span><span class="n">set_attrs</span><span class="p">(</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;border&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;title&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">tui_fmt</span><span class="p">(</span><span class="s">&quot;quit %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;q&#39;</span><span class="p">),</span>
<span class="w">    </span><span class="s">&quot;kbd_move&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">);</span>

<span class="c1">// 组件：色阶画布</span>
<span class="n">root</span><span class="o">-&gt;</span><span class="n">create_widget</span><span class="p">(</span>
<span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="n">tui_ncanvas</span><span class="p">(</span>
<span class="w">    </span><span class="n">tui_rect</span><span class="p">(</span>
<span class="w">      </span><span class="n">global_rect</span><span class="p">.</span><span class="n">tail</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="n">global_rect</span><span class="p">.</span><span class="n">height</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">),</span>
<span class="w">      </span><span class="n">global_rect</span><span class="p">.</span><span class="n">tail</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">)</span><span class="o">-&gt;</span><span class="n">set_attrs</span><span class="p">(</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;border&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;title&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">tui_fmt</span><span class="p">(</span><span class="s">&quot;quit %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;q&#39;</span><span class="p">),</span>
<span class="w">    </span><span class="s">&quot;kbd_move&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">);</span>
</code></pre></div>
</div>
</div>
</div>
<p>注意到我们还是用了 <code>set_attrs()</code> 接口来增加这些新组件的性质。</p>
<p>还可以发现我们加入了一个新性质 <code>kbd_move</code>，加入该性质后，两个组件可以响应键盘事件，从而在屏幕上移动。你可以观察到它们会互相重叠，可以通过鼠标点击来改变它们的堆叠关系。</p>
<p>可以注意到，对于这两个组件添加性质，我们使用的是完全相同的接口（没有重载 <code>set_attrs</code>）。这样做使得组件性质的逻辑也分离于具体组件实现之外，并且可以完全复用。</p>
<p>这又是一种归一化设计的体现：把程序不同部分/组件的相同逻辑抽象出来封装为同一个接口进行复用。不仅简化了代码，还方便了维护。</p>
<p><code>create_widget</code> 将创建好的组件对象指针原样返回，方便我们直接在它创建的对象上调用 <code>set_attr()</code> 接口来增加性质，这种设计叫做<strong>链式调用</strong>。</p>
<p>和之前一样，按 q，焦点所在的窗口会退出，两个都退出后会连带着 root 及整个程序退出。</p>
<p>到这里程序执行的效果如下图：</p>
<p><img alt="" src="../../../pics/proj-p0-demo.png" /></p>
<h2 id="本阶段任务">本阶段任务<a class="headerlink" href="#本阶段任务" title="Permanent link">&para;</a></h2>
<p>推荐你在 12/28 前完成本阶段的任务实践：</p>
<ul>
<li>拉取项目代码</li>
<li>配置好运行环境并正确运行 demo</li>
<li>实践以上内容</li>
<li>完成一个小任务（12/27 18:30 前发布，推荐在此时间之前完成上面步骤）</li>
<li>将完成的任务代码按要求打包提交到指定位置</li>
</ul>
<h2 id="第零阶段代码任务">第零阶段代码任务<a class="headerlink" href="#第零阶段代码任务" title="Permanent link">&para;</a></h2>
<p>本阶段的代码任务的目的是改进 <code>border_proxy</code> 类的功能（定义在 <code>minitui/*/proxies/</code> 中）。</p>
<p>具体来说，要达成如下效果：</p>
<ul>
<li>支持边框在所属组件被鼠标悬停于其上时/成为焦点组件时高亮。</li>
<li>支持在边框右上角添加一个退出按钮子组件。该组件显示为一个红色的 &#9600; (<code>\u2580</code>) 符号，同样应在鼠标悬停在其上时高亮，并在被点击时使得其所在组件退出。</li>
</ul>
<p>实现示例视频如下：</p>
<video controls>
<source src="../../../pics/phase0.mp4" />
</video>

<p>要完成第零阶段的代码任务，必须对代码框架有着更加深入的认识才行。</p>
<p>接下来我们就来讲讲。</p>
<h3 id="组件代理系统入门">组件代理系统入门<a class="headerlink" href="#组件代理系统入门" title="Permanent link">&para;</a></h3>
<h4 id="从-border_proxy-的定义开始">从 <code>border_proxy</code> 的定义开始<a class="headerlink" href="#从-border_proxy-的定义开始" title="Permanent link">&para;</a></h4>
<p>要改进 <code>border_proxy</code>（下称边框代理）类的实现，首先需要了解它原先的实现。</p>
<p>OK，让我们打开 <code>proxies/border_proxy.h</code>，看到：</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">tui_border_proxy</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">tui_widget_proxy</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">factory_reg</span><span class="p">(</span><span class="n">tui_border_proxy</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;border&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="n">tui_border_proxy</span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="p">());</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">tui_rect</span><span class="w"> </span><span class="nf">area_transform</span><span class="p">(</span><span class="n">tui_rect</span><span class="w"> </span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="p">());</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>我们可以看到，该类继承自……<code>tui_widget_proxy</code>，这是个啥类？</p>
<p>OK，认命了，我们接着看这个类的定义吧。</p>
<div class="tabbed-set tabbed-alternate" data-tabs="10:1"><input checked="checked" id="__tabbed_10_1" name="__tabbed_10" type="radio" /><div class="tabbed-labels"><label for="__tabbed_10_1">widget_proxy.h</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">tui_widget_proxy</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">tui_widget</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">factory_reg</span><span class="p">(</span><span class="n">tui_widget_proxy</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;PROXY&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">content</span><span class="p">;</span>
<span class="w">  </span><span class="n">tui_widget_proxy</span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="p">());</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">tui_rect</span><span class="w"> </span><span class="nf">area_transform</span><span class="p">(</span><span class="n">tui_rect</span><span class="w"> </span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="nf">on_event</span><span class="p">(</span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="nf">on_child_exit</span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">child</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="nf">proxy</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="o">~</span><span class="n">tui_widget_proxy</span><span class="p">();</span>
<span class="p">};</span>
</code></pre></div>
</div>
</div>
</div>
<p>总算有我们看得懂的东西了：这个类继承自 <code>tui_widget</code>，看来它也是一个组件派生类。</p>
<p>而 <code>tui_border_proxy</code> 继承了它，说明其是一个在这个组件派生类上实现的一个具体组件。</p>
<p>仔细看看还可以发现 <code>proxies/</code> 目录下的其他类都继承了 <code>tui_widget_proxy</code>。</p>
<p>这是一种<strong>多层继承</strong>的设计，<code>tui_widget_proxy</code> 既是具有 <code>tui_widget</code> 特征/接口的派生类，也是一系列二级派生类共同特征/接口的基类。</p>
<p>换句话说，<code>tui_widget_proxy</code> 本身代表的是一系列具体组件类，即 minitui 中的<strong>「组件代理」</strong>，而边框代理类 <code>tui_border_proxy</code> 则是组件代理类之一。</p>
<p>那么什么是组件代理呢？现在就来介绍 minitui 中组件代理的概念。</p>
<h4 id="组件代理装饰器模式">组件代理：装饰器模式<a class="headerlink" href="#组件代理装饰器模式" title="Permanent link">&para;</a></h4>
<p>设想一个会输出全空的组件，就像这样：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">tui_some_widget::draw</span><span class="p">(</span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">putchar</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>现在我们希望让它在边缘不输出空而输出 'X'，应该怎么做呢？</p>
<p>也许可以写出这样的代码：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">tui_some_widget::draw</span><span class="p">(</span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">area</span><span class="p">.</span><span class="n">height</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;X&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">area</span><span class="p">.</span><span class="n">width</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;X&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">putchar</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>此时我们发现，对于任意组件，如果我们需要在它的边缘输出 'X'，都可以用一个类似的模式：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">tui_some_widget::draw</span><span class="p">(</span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">area</span><span class="p">.</span><span class="n">height</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;X&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">area</span><span class="p">.</span><span class="n">width</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;X&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// 进行原来的画图工作</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<p>当需要为一个现有组件添加上 'X' 边框时，可以按照这个套路修改其 <code>draw()</code> 方法。但当需要为多个组件添加 'X' 边框时，这样做就需要为每个组件重新写一遍相同的逻辑，不仅麻烦而且不灵活。</p>
<p>有什么办法能够将这段边框逻辑抽取出来，封装到单个实体中呢？</p>
<p>这就是组件代理要做的事情。
每个具体的组件代理类都封装了一段这样的功能逻辑，从而使其实例能够将该逻辑应用到<em>被代理的</em>组件上。</p>
<p>现在我们就能够看懂组件代理基类的定义了：</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">tui_widget_proxy</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">tui_widget</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 注册此组件代理的“功能名”，后面我们会看到它的用处</span>
<span class="w">  </span><span class="n">factory_reg</span><span class="p">(</span><span class="n">tui_widget_proxy</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;PROXY&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">content</span><span class="p">;</span>
<span class="w">  </span><span class="n">tui_widget_proxy</span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="p">());</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">tui_rect</span><span class="w"> </span><span class="nf">area_transform</span><span class="p">(</span><span class="n">tui_rect</span><span class="w"> </span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="nf">on_event</span><span class="p">(</span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="nf">on_child_exit</span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">child</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="nf">proxy</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="o">~</span><span class="n">tui_widget_proxy</span><span class="p">();</span>
<span class="p">};</span>
</code></pre></div>
<p>首先，组件代理基类继承自组件类，也就是说它实现了组件的全部接口。</p>
<p>同时，它还具有一个 <code>tui_widget *</code> 类型的属性 <code>content</code>，这就是指向被代理组件的指针。</p>
<p>再看其构造函数，除了接受 <code>content</code> 指针外，其还能够接受一个字符串列表作为参数（列表）。</p>
<p>再来看看其重载的几个组件接口：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span>
<span class="nf">tui_widget_proxy::draw</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span>
<span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">draw</span><span class="p">(</span><span class="n">point</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">tui_event</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_widget_proxy::on_event</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">on_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_widget_proxy::proxy</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">content</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">tui_event</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_widget_proxy::on_child_exit</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">child</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">on_child_exit</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>可以看到，其接口实现就是调用其所代理组件的接口。</p>
<p>看到这里，你可能会问：这么实现有什么用？只是增加了一个中间层而已。</p>
<p>是时候回顾我们计算机科学的至理名言了：</p>
<div class="admonition quote">
<p class="admonition-title">一言</p>
<p>All problems in computer science can be solved by another level of indirection.<br/>
（计算机科学领域的所有问题都可以通过增加一个中间层解决）
<div style="text-align:right"> —— David Wheeler </div></p>
</div>
<p>因为我们能够在派生类中重载这个「中间层」的实现，事实上相当于我们能够在此层里拦截被代理组件的接口调用。</p>
<p>于是我们可以在调用被代理组件接口之前，之后进行一些处理，或者干脆不调用被代理组件接口而顶替掉这一调用。</p>
<p>因此，对应某具体功能的一个派生组件代理类的接口可以实现成这样：</p>
<div class="highlight"><pre><span></span><code><span class="k">auto</span><span class="w"> </span><span class="n">tui_widget_proxy</span><span class="o">::</span><span class="n">some_interface</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">some_condition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// do something before calling content widget</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">content_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">some_interface</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// do something after calling content widget</span>
<span class="w">    </span><span class="c1">// do something to the return value</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">content_res</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// do something else</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">what_i_want_to_return</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>这种方法叫做<a href="https://zh.wikipedia.org/zh-cn/%E9%92%A9%E5%AD%90%E7%BC%96%E7%A8%8B">钩子编程</a>。运用钩子，可以使我们灵活地监视/修改已实现的程序功能。</p>
<p>钩子被广泛运用在调试，benchmarking，重定义系统 API，甚至游戏外挂等恶意程序中。</p>
<p>在面向对象的设计模式中，这种方法还有一个名字，叫做「装饰器模式」，这一名字更强调这种方法利用的「对象套对象」的模式。外层的对象被叫做「装饰器对象」。</p>
<p>在 minitui 中，我们将这些钩取、代理了内部组件接口的对象叫做<strong>「组件代理」</strong>。</p>
<h4 id="如何给组件套壳代理链">如何给组件「套壳」：代理链<a class="headerlink" href="#如何给组件套壳代理链" title="Permanent link">&para;</a></h4>
<p>乍一看这个标题问的没啥意义：既然都已经有了代理类，直接新建一个代理对象，将被代理组件的指针传进去构造不就好了？然而这里还存在两个问题：</p>
<ul>
<li>如果原组件已经被注册到窗口上了，新的组件代理需要替换原组件在窗口树和窗口管理器中的位置。同时还需要转交原组件和外部系统有关的属性给组件代理，我们把这些属性称作<em>外部属性</em>。</li>
<li>在套完壳之后，外部系统在只有外层组件代理指针的情况，怎么访问内部组件信息呢？内部组件又怎么访问到外层代理的信息呢？</li>
</ul>
<p>对于第一个问题，我们已经在 <code>tui_widget_proxy</code> 的构造函数中实现了，具体细节这里不表。总之，它替换了窗口系统中原内层组件的位置（包括 <code>root</code>），同时将 <code>parent</code>、<code>children</code> 等外部属性转交给了外层代理。</p>
<p>为解决第二个问题，我们需要实现一个能从外部代理访问内部组件或反之的接口。</p>
<p>我们知道，每个代理都能够通过 <code>content</code> 来访问内层组件。但是由于我们处理组件时并不知道一个组件是不是一个代理组件（因为<a href="#具体组件归一化多态">多态</a>），所以我们需要在组件基类实现一个接口来判断，这就是 <code>proxy()</code> 接口。</p>
<p>我们来看基类对于此接口的实现：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// no proxy</span>
<span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_widget::proxy</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>再来对比 <code>tui_widget_proxy</code> 基类的实现：</p>
<div class="highlight"><pre><span></span><code><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_widget_proxy::proxy</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">content</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>可以发现只需要调用这个接口就可以判断组件是否是代理，且若是的话可以获取内部组件指针。</p>
<p>容易想到，有时候我们会进行组件代理的嵌套来加上多个功能，这在<a href="#第二个-minitui-程序增加功能">前面的例子</a>中同样体现了。</p>
<p>于是，组件代理的嵌套事实上形成了一个链表状结构，我们叫它<strong>代理链</strong>。</p>
<p>这个链以组件为元素，以最外层组件为头部，以最内层非代理组件为尾部，以 <code>proxy()</code> 接口作为 <code>next</code> 指针。它满足链表的性质：从头部元素开始的 <code>next</code> 挨个接上了每个元素，尾部元素的 <code>next</code> 是 <code>NULL</code>。</p>
<p>同时请记住，在引入组件代理系统之后，外部系统处理的组件指针就都是代理链的头部组件（即最外层组件）了。
而每个这样的组件代表的是一整条组件链而不是单个组件。</p>
<p>现在回到正题，当外部系统希望获取某组件（代理链，下面不再区分）的最内层组件时，可以通过在代理链上递归来实现。</p>
<p>minitui 实现了组件的 <code>proxy_penetrator</code> 接口来实现这一功能。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 返回代理链最内层组件</span>
<span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_widget::proxy_penetrator</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 还能往内走</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">proxy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">proxy</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">proxy_penetrator</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// 已经抵达末尾</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>进一步地，我们可以把部分外部系统对于组件外部属性的访问直接封装成接口，令其直接操作最内层组件的对应属性，这样可以做到<em>不需移交组件的外部属性给外层组件</em>。</p>
<p>例如 <code>updated</code>：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="11:1"><input checked="checked" id="__tabbed_11_1" name="__tabbed_11" type="radio" /><div class="tabbed-labels"><label for="__tabbed_11_1">widget.h</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">set_updated</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">proxy_penetrator</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">};</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">reset_updated</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">proxy_penetrator</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">};</span>
<span class="kt">bool</span><span class="w"> </span><span class="nf">get_updated</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">proxy_penetrator</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">updated</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<details class="tip" open="open">
<summary>批判性思考：所以到底为什么要转交外部属性？</summary>
<p>到这已经可以看出，将组件的外部属性交给外层代理组件的实现是不好的。</p>
<p>一个可能更好的实现方式是将其保留在最内层。因为随着外层代理的动态变化，外部属性需要反复在不同组件之间传递，比较麻烦而且容易出错。</p>
<p>最简单的例子是删除一个最外层代理，就需要将所有的外部属性转交给次外层的组件。</p>
<p>如果将所有外部属性全部保留在内部，只需要像对 <code>updated</code> 那样，封装获取外部属性的接口，并限制外部属性为私有，只从接口访问属性即可。</p>
<p>事已至此，我们还是来看看怎么为不良的设计擦屁股吧。</p>
</details>
<p>由于外部属性已经被转移到外部代理，内层组件在需要访问外部属性时也需要追溯到最外层代理。</p>
<p>因此，我们在组件中添加了 <code>unproxy</code> 属性，它会在组件被用于构造外层代理时自动指向外层代理。借此容易实现追溯到最外层代理的 <code>unproxy_penetrator()</code> 方法：</p>
<div class="highlight"><pre><span></span><code><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_widget::unproxy_penetrator</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">unproxy</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">unproxy</span><span class="o">-&gt;</span><span class="n">unproxy_penetrator</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>同理，可以将部分外部属性的访问直接封装成接口，来避免手动调用这个方法：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="12:1"><input checked="checked" id="__tabbed_12_1" name="__tabbed_12" type="radio" /><div class="tabbed-labels"><label for="__tabbed_12_1">widget.h</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="nf">get_parent</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">unproxy_penetrator</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">get_children</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">unproxy_penetrator</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<h4 id="牛刀小试x-边框">牛刀小试："X" 边框<a class="headerlink" href="#牛刀小试x-边框" title="Permanent link">&para;</a></h4>
<p>现在我们再回顾刚刚说的 "X" 边框功能，可以这样将它封装为一个组件代理类：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 继承组件代理基类</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">tui_xborder_proxy</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">tui_widget_proxy</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 注册功能名为 &quot;xborder&quot;</span>
<span class="w">  </span><span class="n">factory_reg</span><span class="p">(</span><span class="n">tui_xborder_proxy</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;xborder&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="n">tui_xborder_proxy</span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="p">());</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">tui_xborder_proxy</span><span class="o">::</span><span class="n">tui_xborder_proxy</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">content</span><span class="p">,</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span>
<span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">tui_widget_proxy</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 大部分工作基类构造函数都已经做了</span>
<span class="w">  </span><span class="c1">// 这里的处理很复杂，详见下一个小部分</span>
<span class="w">  </span><span class="c1">// 需要注意边框组件需要比被代理组件大一圈</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">instaniated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 如果已经被注册显示，需要调用 `tui_adjust_widget` 更新一下 `full_map`</span>
<span class="w">    </span><span class="c1">// 注意最后一个 `false` 表示不递归改变嵌套的代理的 `area`</span>
<span class="w">    </span><span class="n">tui_adjust_widget</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">tui_rect</span><span class="p">(</span>
<span class="w">      </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span>
<span class="w">      </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">tail</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">),</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tui_rect</span><span class="p">(</span>
<span class="w">      </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span>
<span class="w">      </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">tail</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">tui_xborder_proxy</span><span class="o">::</span><span class="n">draw</span><span class="p">(</span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">area</span><span class="p">.</span><span class="n">height</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;X&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">area</span><span class="p">.</span><span class="n">width</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;X&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// 注意相对位置改变</span>
<span class="w">  </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">draw</span><span class="p">(</span><span class="n">point</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<p>这样，我们就终于成功将 "X" 边框逻辑封装到 <code>tui_xborder_proxy</code> 中了。</p>
<p>要使用这个功能，只需引用我们为它注册的功能名即可：</p>
<div class="highlight"><pre><span></span><code><span class="k">auto</span><span class="w"> </span><span class="n">some_widget</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tui_some_widget</span><span class="p">(</span><span class="n">globel_rect</span><span class="p">);</span>
<span class="n">some_widget</span><span class="o">-&gt;</span><span class="n">set_attrs</span><span class="p">({</span><span class="s">&quot;xborder&quot;</span><span class="p">});</span>
</code></pre></div>
<h4 id="代理机制下的-area-处理">代理机制下的 <code>area</code> 处理<a class="headerlink" href="#代理机制下的-area-处理" title="Permanent link">&para;</a></h4>
<p>我们知道 <code>area</code> 表示的是组件占据的矩形区域。</p>
<p>在大部分情况下，代理的 <code>area</code> 是和被代理组件一样的，这也是 <code>tui_widget_proxy</code> 组件的默认处理方式。</p>
<p>但是，可以注意到上面代码有非常复杂的关于 <code>area</code> 的处理，这是为什么呢？</p>
<p>首先，边框需要比内部组件大一圈，因此 <code>tui_xborder_proxy</code> 对象的 <code>area</code> 必须比 <code>content</code> 指向对象的 <code>area</code> 大一圈。</p>
<p>其次，在内部组件已经注册显示的情况下，基类构造函数会首先把边框代理自己即 <code>this</code> 替换上去，此时 <code>instantiated</code> 为 <code>true</code>。</p>
<p>这时,改变自己的 <code>area</code> 会使得 <code>full_map</code> 出现不同步的情况（增长的一圈的 <code>full_map</code> 没改），需要调用 <code>tui_adjust_widget</code> 接口。</p>
<p>这个接口是怎么实现的呢？为什么加了个 <code>false</code> 参数？RTFSC，马上来看看源码吧：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span>
<span class="nf">tui_adjust_widget</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">widget</span><span class="p">,</span>
<span class="w">  </span><span class="n">tui_rect</span><span class="w"> </span><span class="n">area</span><span class="p">,</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">proxy_penetrate</span><span class="w"> </span><span class="c1">// 默认是 `true`</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Debug</span><span class="p">(</span><span class="s">&quot;Adjusting widget %p %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">widget</span><span class="p">,</span><span class="w"> </span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">  </span><span class="n">tui_assert</span><span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">instaniated</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// 在 `full_map` 中清除掉这个组件</span>
<span class="w">  </span><span class="n">tui_update_full_map</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// 修改 `area`</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">area</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">proxy_penetrate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">reset_area</span><span class="p">(</span><span class="n">area</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">area</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// 在 `full_map` 中增加上这个组件</span>
<span class="w">  </span><span class="n">tui_update_full_map</span><span class="p">(</span><span class="n">widget</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>注意到第三个参数为 <code>true</code> 的情况下会调用 <code>reset_area</code> 接口而不是直接修改 <code>area</code>，我们来看看这个接口的实现：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span>
<span class="nf">tui_widget::reset_area</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_rect</span><span class="w"> </span><span class="n">area</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 通知组件即将被修改 `area`</span>
<span class="w">  </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">on_area_change</span><span class="p">(</span><span class="n">area</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// 若有内部组件，先对内部组件应用同样**相对**幅度的 `area` 修改。</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">proxy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">proxy</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">reset_area</span><span class="p">(</span>
<span class="w">      </span><span class="n">tui_rect</span><span class="p">(</span>
<span class="w">        </span><span class="n">area</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">proxy</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">head</span><span class="p">,</span>
<span class="w">        </span><span class="n">area</span><span class="p">.</span><span class="n">tail</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">proxy</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">tail</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">tail</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// 最终修改 `area`</span>
<span class="w">  </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">area</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>OK，现在我们终于懂了：</p>
<ul>
<li><code>reset_area</code> 的功能是修改一个组件的 <code>area</code>，同时将其代理链上的组件的 <code>area</code> 全部做对应修改。</li>
<li><code>tui_adjust_widget</code> 的功能是修改一个<strong>已注册</strong>的组件的 <code>area</code>，在 <code>proxy_penetrate</code> 为真的情况下，需要连着代理链一起修改，否则就只需要修改组件本身。</li>
<li>调用 <code>tui_adjust_widget</code> 的目的就是要调大作为已注册组件的边框代理的 <code>area</code>，但是显然我们不需要连着内部代理链一起修改，所以把第三个参数设为 <code>false</code>。</li>
</ul>
<details class="tip" open="open">
<summary>批判性思考：能不能避免这个特判</summary>
<p>这个特判看起来很不优雅，我们能不能避免它？</p>
<p>一个方案是增加一个 <code>set_area</code> 接口来接管对组件 <code>area</code> 的修改：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span>
<span class="nf">tui_widget::set_area</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_rect</span><span class="w"> </span><span class="n">area</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">penetrate</span><span class="o">=</span><span class="nb">false</span><span class="w"> </span><span class="c1">// 修改应用在组件本身还是整个组件链上</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 特判要不要更新 `full_map`</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">instaniated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 更新 `full_map` 的同时更新 `area`</span>
<span class="w">    </span><span class="n">tui_adjust_widget</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="n">penetrate</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 直接修改 `area`</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">penetrate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">reset_area</span><span class="p">(</span><span class="n">area</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 通知组件即将被修改 `area`</span>
<span class="w">      </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">on_area_change</span><span class="p">(</span><span class="n">area</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">area</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>现在的逻辑就变为：</p>
<ul>
<li><code>tui_widget::reset_area</code> 是个工具方法，负责把 <code>area</code> 的修改传导到组件链上，只有对组件链修改的时候才会被调用。</li>
<li><code>tui_adjust_widget</code> 针对的是被注册的组件的 <code>area</code> 改变，可以仅对组件本身修改，也可以针对整个组件链修改。只要组件是被注册的，它能够独立完成整个流程。</li>
<li><code>tui_widget::set_area</code> 是最外部的修改 <code>area</code> 入口，如果组件被注册就调用 <code>tui_adjust_widget</code>，否则就自己完成修改流程。</li>
</ul>
<p>现在，在 <code>tui_xborder_proxy</code> 的构造函数处就只需要调用 <code>set_area</code> 就行了。</p>
<p>虽然变得优雅了一点，但是整个逻辑还是相当的复杂，在下面我们接着讨论导致逻辑复杂的原因。</p>
</details>
<details class="tip" open="open">
<summary>批判性思考：<code>full_map</code> 的问题</summary>
<p>这里可以看出，导致这么蛋疼的原因是 <code>full_map</code> 机制：每当被注册的窗口改变区域的时候，都要重新维护 <code>full_map</code>。这就导致了上面描述的调整组件区域出现了需要判断 <code>instaniated</code> 属性而采用不同逻辑的特性。</p>
<p><code>full_map</code> 本质来说是对 <code>tui_look_widget()</code> 结果的缓存，在下一阶段代码中我们可能直接删除它。</p>
<p>在删除它以后，<code>tui_adjust_widget()</code> 就没有必要存在了，统一走 <code>set_area()</code> 或者直接调用 <code>reset_area</code> 和直接赋值即可。不过我们还是推荐使用前者，具体原因再见下一个小贴士。</p>
</details>
<details class="tip" open="open">
<summary>批判性思考：直接访问成员 vs 封装成员访问接口</summary>
<p>minitui 的框架代码中的所有类成员都是公开可访问的，并且大量存在直接访问对象成员的代码。</p>
<p>这样做其实是破坏了对象的抽象的——许多时候我们希望一个对象的成员在被访问时（读取/修改）时总是进行一些额外的操作，例如上面提到过的：</p>
<ul>
<li>我们希望在组件的 <code>updated</code> 被读取时，总是返回最内层真实组件的 <code>updated</code> 属性。</li>
<li>我们希望在组件的 <code>area</code> 被修改时，总会调用组件的 <code>on_area_change()</code> 接口。</li>
</ul>
<p>这个时候，将成员访问封装成接口就可以方便复用以及灵活调整这部分逻辑了。</p>
<p>可以发现，这个封装接口的过程也可说是一种增加中间层，我们计算机科学领域名言的含金量还在上升。</p>
</details>
<h4 id="代理功能参数机制">代理/功能参数机制<a class="headerlink" href="#代理功能参数机制" title="Permanent link">&para;</a></h4>
<p>在根据功能创建代理时，minitui 允许在功能名后添加参数。</p>
<p>例如<a href="#第二个-minitui-程序增加功能">第二个 minitui 程序</a>中用到的 <code>quit</code> 功能，其定义格式为 <code>quit CODE</code>，<code>CODE</code> 就是一个参数。具体来说，代理名后以空格分隔的每个词都是一个参数，所有参数组成参数列表 <code>args</code> 和被代理组件指针一起被传入代理的构造函数。</p>
<p>因此，minitui 的所有组件代理的构造函数参数格式统一为 <code>(tui_widget *content, std::vector&lt;tui_fmt&gt; args)</code>。再提一嘴，<code>tui_fmt</code> 只是一个字符串的包装。</p>
<h4 id="实例学习tui_quit_proxy">实例学习：<code>tui_quit_proxy</code><a class="headerlink" href="#实例学习tui_quit_proxy" title="Permanent link">&para;</a></h4>
<p>现在让我们继续看看 <code>quit</code> 功能的实现。</p>
<p>该功能定义格式为 <code>quit CODE</code>，能够让组件在接收到 <code>CODE</code> 参数对应的键码时退出。</p>
<p><code>quit</code> 功能是由 <code>tui_quit_proxy</code> 注册的，现在我们来看看它是如何实现该功能的：</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">tui_quit_proxy</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">tui_widget_proxy</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">factory_reg</span><span class="p">(</span><span class="n">tui_quit_proxy</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;quit&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">quit_key</span><span class="p">;</span>

<span class="w">  </span><span class="n">tui_quit_proxy</span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="n">tui_widget_proxy</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tui_assert</span><span class="p">(</span><span class="o">!</span><span class="n">args</span><span class="p">.</span><span class="n">empty</span><span class="p">());</span>
<span class="w">    </span><span class="c1">// 解析 `CODE` 参数</span>
<span class="w">    </span><span class="n">quit_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]());</span>
<span class="w">    </span><span class="n">args</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">tui_fmt</span><span class="p">(</span><span class="s">&quot;%d_QUIT_PROXY&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">quit_key</span><span class="p">)());</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="n">on_event</span><span class="p">(</span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tui_event</span><span class="o">*</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tui_event</span><span class="o">::</span><span class="n">exit_on_key</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="n">quit_key</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">on_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="o">~</span><span class="n">tui_quit_proxy</span><span class="p">()</span><span class="w"> </span><span class="p">{};</span>
<span class="p">};</span>
</code></pre></div>
<p>正好我没有（其实是懒得）将方法实现和类定义分离，我们可以直观看到它的接口实现。</p>
<p>可以看到：</p>
<ul>
<li><code>tui_quit_proxy</code> 额外增加了一个属性 <code>quit_key</code>，用于在代理对象中保存需要响应的键码。</li>
<li>在接收事件时调用 <code>tui_event::exit_on_key</code> 方法，该方法实现如下：
    <div class="highlight"><pre><span></span><code><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_event::exit_on_key</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">,</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">retcode</span><span class="w"> </span><span class="c1">// 默认为 0</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 如果是键码为 key 的键盘事件，就返回退出事件</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">check_key</span><span class="p">(</span><span class="n">key</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="n">event</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tui_event</span><span class="p">(</span>
<span class="w">      </span><span class="n">TUI_EXIT_EVENT</span><span class="p">,</span>
<span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="n">tui_exit_event</span><span class="p">(</span><span class="n">retcode</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// 否则返回空</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"> </span>
<span class="p">}</span>
</code></pre></div>
    容易看到只需在 <code>res</code> 非空时直接返回 <code>res</code>（退出事件），否则调用 <code>content</code> 接口即可。</li>
<li>其他接口都不需要处理，直接调用被代理组件接口即可。</li>
</ul>
<h4 id="set_attrs-的庐山真面目"><code>set_attrs</code> 的庐山真面目<a class="headerlink" href="#set_attrs-的庐山真面目" title="Permanent link">&para;</a></h4>
<p>我们之前已经看到，可以通过调用组件的 <code>set_attrs()</code> 方法来在不改变组件实现的情况下为其添加功能。</p>
<p>事实上，到这里你应该可以猜到 <code>set_attrs()</code> 是通过组件代理机制实现的。</p>
<div class="highlight"><pre><span></span><code><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_widget::set_attrs</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">attrs</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">tui_proxy_factory</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>这里它接受一个 <code>tui_fmt</code>（即我们实现的格式化字符串）列表为参数，将自己和这个列表作为参数调用了 <code>tui_proxy_factory::add()</code> 函数。</p>
<p>顾名思义，这个函数是专门负责解析性质列表，然后按此给某个组件嵌套上代理组件的。</p>
<div class="tabbed-set tabbed-alternate" data-tabs="13:1"><input checked="checked" id="__tabbed_13_1" name="__tabbed_13" type="radio" /><div class="tabbed-labels"><label for="__tabbed_13_1">proxy_factory.h</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="nf">proxy_add</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">widget</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">proxy_name</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">proxy</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">proxy_create_list</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">proxy</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">proxy_name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">proxy</span><span class="p">.</span><span class="n">second</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">Warn</span><span class="p">(</span><span class="s">&quot;Proxy not found: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">proxy_name</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">widget</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="nf">add</span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">widget</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">attrs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">attrs</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">widget</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">widget</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">attr</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">attrs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// parse the proxy name in tui_fmt attr</span>
<span class="w">    </span><span class="n">tui_fmt</span><span class="w"> </span><span class="n">proxy_name</span><span class="p">(</span><span class="n">strtok</span><span class="p">(</span><span class="n">attr</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// parse the attributes in tui_fmt attr</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">curr_args</span><span class="p">{};</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">attr_str</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">attr_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtok</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">curr_args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">tui_fmt</span><span class="p">(</span><span class="n">attr_str</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proxy_add</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">proxy_name</span><span class="p">(),</span><span class="w"> </span><span class="n">curr_args</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<p>观察这段代码，我们可以注意到：</p>
<ul>
<li>性质字符串以空格分割的第一个 token 是代理名称（用于索引代理），其后的 token 被装进列表作为参数传给代理组件的构造函数。</li>
<li>写在前面的性质转化成的代理会被嵌套在内层。</li>
<li>代理名和实际代理组件构造函数的映射关系被存在 <code>proxy_create_list</code> 中。</li>
</ul>
<p>这个 <code>proxy_create_list</code> 是怎么维护的呢？</p>
<p>具体原理比较复杂，我们直接讲如何把一个代理组件类的代理名-构造函数对注册入该表。</p>
<p>以 <code>tui_border_proxy</code> 为例，只需在类定义时添加：</p>
<div class="highlight"><pre><span></span><code><span class="n">factory_reg</span><span class="p">(</span><span class="n">tui_border_proxy</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;border&quot;</span><span class="p">);</span>
</code></pre></div>
<p>在类的实现文件 <code>*.cpp</code> 中添加：</p>
<div class="highlight"><pre><span></span><code><span class="n">factory_reg_impl</span><span class="p">(</span><span class="n">tui_border_proxy</span><span class="p">);</span>
</code></pre></div>
<p>这样就可以通过在 <code>set_attrs</code> 时传入 <code>"border [arg1 arg2 ...]"</code> 来为组件创建 <code>tui_border_proxy</code> 代理组件以实现边框性质了。</p>
<div class="admonition warning">
<p class="admonition-title">建设中</p>
<p>以下部分正在建设中。内容暂时属于草稿，仅供参考。</p>
</div>
<h3 id="边框代理实现">边框代理实现<a class="headerlink" href="#边框代理实现" title="Permanent link">&para;</a></h3>
<p>我们先从原来的边框代理实现讲起，然后再提供实现新的边框代理的思路。</p>
<h4 id="构造函数">构造函数<a class="headerlink" href="#构造函数" title="Permanent link">&para;</a></h4>
<p>首先我们需要在构造函数中根据传入的参数初始化边框代理组件。</p>
<p>这里需要解释一下目前实现的初始化逻辑（注意到边框组件必须比被代理组件大一圈）：</p>
<ul>
<li>如果有 <code>shrink</code> 参数，则将被代理组件缩小一圈。</li>
<li>如果没有 <code>shrink</code> 参数，则将自己放大一圈（默认和被代理组件一样大）。<ul>
<li>注意如果本组件被作为窗口注册显示，需要调用 <code>ui</code> 模块的接口改变自己的大小。否则 <code>full_map</code> 不会被正确地更新。</li>
</ul>
</li>
</ul>
<p>原来的实现是：</p>
<div class="highlight"><pre><span></span><code><span class="n">tui_border_proxy</span><span class="o">::</span><span class="n">tui_border_proxy</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">content</span><span class="p">,</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span>
<span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">tui_widget_proxy</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;shrink&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">reset_area</span><span class="p">(</span><span class="n">tui_rect</span><span class="p">(</span>
<span class="w">      </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span>
<span class="w">      </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">tail</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">instaniated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">tui_adjust_widget</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">tui_rect</span><span class="p">(</span>
<span class="w">        </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">tail</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="p">),</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tui_rect</span><span class="p">(</span>
<span class="w">        </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">tail</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>


<span class="w">  </span><span class="n">tui_assert</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">isvalid</span><span class="p">());</span>
<span class="w">  </span><span class="n">strcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;BORDER_PROXY&quot;</span><span class="p">);</span>
<span class="p">}</span><span class="w">    </span>
</code></pre></div>
<h2 id="后续任务预告--建议">后续任务预告 &amp; 建议<a class="headerlink" href="#后续任务预告--建议" title="Permanent link">&para;</a></h2>
<ul>
<li>第一阶段：实现窗口框架和布局。推荐 1/5 前完成。</li>
<li>第二阶段：实现各种小组件和 <code>proxy</code> 类。推荐 1/10 前完成。</li>
<li>第三阶段：实现图片查看器。推荐 1/15 前完成。</li>
</ul>
<p>大作业提交预计在 1/16 前后截止（因为需要在 1/18 左右评分完成），需要提交一份实验报告（markdown/tex/typst 格式均可）。</p>
<p>建议尽量结合教程的讲解和文档（后续会跟进）多读读框架代码，尤其是教程讲解中提到但是没有细说的实现（不可能讲的那么细），最好把其原理都读明白。</p>
<p><del>当然，其实是三到五天就可以完成全部任务的。</del></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 Problem-Solving (2024) TA Team
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.indexes", "content.tooltips"], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="../../../javascripts/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
      
    
  </body>
</html>