
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../quickstart/">
      
      
        <link rel="next" href="../phase2/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.41">
    
    
      
        <title>第一阶段 - 2024 级问题求解（程设部分）</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i,700,700i%7CFira+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Fira Sans";--md-code-font:"Fira Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../css/heimu.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#第一阶段" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="2024 级问题求解（程设部分）" class="md-header__button md-logo" aria-label="2024 级问题求解（程设部分）" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3 1 9l11 6 9-4.91V17h2V9M5 13.18v4L12 21l7-3.82v-4L12 17z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            2024 级问题求解（程设部分）
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              第一阶段
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="red"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ps24-prog/ps-wiki" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    ps-wiki
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../.." class="md-tabs__link">
          
  
    
  
  主版

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
    
  
  项目

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../start/" class="md-tabs__link">
          
  
    
  
  指南

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../oj/" class="md-tabs__link">
          
  
    
  
  OJ

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../lab/" class="md-tabs__link">
          
  
    
  
  Lab

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="2024 级问题求解（程设部分）" class="md-nav__button md-logo" aria-label="2024 级问题求解（程设部分）" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3 1 9l11 6 9-4.91V17h2V9M5 13.18v4L12 21l7-3.82v-4L12 17z"/></svg>

    </a>
    2024 级问题求解（程设部分）
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ps24-prog/ps-wiki" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    ps-wiki
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../.." class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    主版
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            主版
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    项目
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            项目
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../document/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    文档
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            文档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../document/ui/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ui
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../document/widget/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    widget
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../document/timer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    timer
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" checked>
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    教程
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            教程
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quickstart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第零阶段
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    第一阶段
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    第一阶段
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#引入" class="md-nav__link">
    <span class="md-ellipsis">
      引入
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#任务描述" class="md-nav__link">
    <span class="md-ellipsis">
      任务描述
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#组件代理系统入门" class="md-nav__link">
    <span class="md-ellipsis">
      组件代理系统入门
    </span>
  </a>
  
    <nav class="md-nav" aria-label="组件代理系统入门">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#从-border_proxy-的定义开始" class="md-nav__link">
    <span class="md-ellipsis">
      从 border_proxy 的定义开始
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#组件代理装饰器模式" class="md-nav__link">
    <span class="md-ellipsis">
      组件代理：装饰器模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#如何给组件套壳代理链" class="md-nav__link">
    <span class="md-ellipsis">
      如何给组件「套壳」：代理链
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#牛刀小试x-边框" class="md-nav__link">
    <span class="md-ellipsis">
      牛刀小试："X" 边框
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#代理机制下的-area-处理" class="md-nav__link">
    <span class="md-ellipsis">
      代理机制下的 area 处理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#代理功能参数机制" class="md-nav__link">
    <span class="md-ellipsis">
      代理/功能参数机制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#实例学习tui_quit_proxy" class="md-nav__link">
    <span class="md-ellipsis">
      实例学习：tui_quit_proxy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_attrs-的庐山真面目" class="md-nav__link">
    <span class="md-ellipsis">
      set_attrs 的庐山真面目
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#原有边框代理实现" class="md-nav__link">
    <span class="md-ellipsis">
      原有边框代理实现
    </span>
  </a>
  
    <nav class="md-nav" aria-label="原有边框代理实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#构造函数" class="md-nav__link">
    <span class="md-ellipsis">
      构造函数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#边框显示" class="md-nav__link">
    <span class="md-ellipsis">
      边框显示
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#功能注册" class="md-nav__link">
    <span class="md-ellipsis">
      功能注册
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#退出按钮子组件" class="md-nav__link">
    <span class="md-ellipsis">
      退出按钮子组件
    </span>
  </a>
  
    <nav class="md-nav" aria-label="退出按钮子组件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#框架系统引入" class="md-nav__link">
    <span class="md-ellipsis">
      框架系统引入
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#任务一实现退出按钮组件类" class="md-nav__link">
    <span class="md-ellipsis">
      任务一：实现退出按钮组件类
    </span>
  </a>
  
    <nav class="md-nav" aria-label="任务一：实现退出按钮组件类">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#创建新组件类" class="md-nav__link">
    <span class="md-ellipsis">
      创建新组件类
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#实现退出按钮类" class="md-nav__link">
    <span class="md-ellipsis">
      实现退出按钮类
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#测试退出按钮类" class="md-nav__link">
    <span class="md-ellipsis">
      测试退出按钮类
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#任务二将退出按钮作为子组件添加到-border_proxy-中" class="md-nav__link">
    <span class="md-ellipsis">
      任务二：将退出按钮作为子组件添加到 border_proxy 中
    </span>
  </a>
  
    <nav class="md-nav" aria-label="任务二：将退出按钮作为子组件添加到 border_proxy 中">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#创建回收子组件" class="md-nav__link">
    <span class="md-ellipsis">
      创建/回收子组件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#管理子组件绘制" class="md-nav__link">
    <span class="md-ellipsis">
      管理子组件绘制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#管理子组件事件" class="md-nav__link">
    <span class="md-ellipsis">
      管理子组件事件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#测试子组件" class="md-nav__link">
    <span class="md-ellipsis">
      测试子组件
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#悬停识别" class="md-nav__link">
    <span class="md-ellipsis">
      悬停识别
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../phase2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第二阶段
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../phase3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第三阶段
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../submission/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    提交和评分
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../start/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    指南
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            指南
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../start/quickstart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    快速上手
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../start/beforeps/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    写在问求之前
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../start/code-style/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    代码风格
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../start/program/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    程序设计基础
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            程序设计基础
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5_2" >
        
          
          <label class="md-nav__link" for="__nav_3_5_2" id="__nav_3_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    C++ 基础
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_2">
            <span class="md-nav__icon md-icon"></span>
            C++ 基础
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/helloworld/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hello, World!
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/basic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    C++ 语法基础
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/var/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    变量
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/op/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    运算
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5_2_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5_2_5" id="__nav_3_5_2_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    流程控制语句
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_5_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_2_5">
            <span class="md-nav__icon md-icon"></span>
            流程控制语句
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/branch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    分支
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/loop/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    循环
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5_2_6" >
        
          
          <label class="md-nav__link" for="__nav_3_5_2_6" id="__nav_3_5_2_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    高级数据类型
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_5_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_2_6">
            <span class="md-nav__icon md-icon"></span>
            高级数据类型
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/array/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    数组
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/struct/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    结构体
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/union/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    联合体
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/pointer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    指针
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/func/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    函数
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/file-op/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    文件操作
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../lang/csl/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    C++ 标准库
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_5_3" id="__nav_3_5_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_3">
            <span class="md-nav__icon md-icon"></span>
            C++ 标准库
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_5_3_2" id="__nav_3_5_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    STL 容器
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_5_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_3_2">
            <span class="md-nav__icon md-icon"></span>
            STL 容器
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/csl/container/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    STL 容器简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/csl/iterator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    迭代器
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/csl/sequence-container/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    序列式容器
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/csl/associative-container/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    关联式容器
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/csl/unordered-container/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    无序关联式容器
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/csl/container-adapter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    容器适配器
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/csl/algorithm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    STL 算法
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/csl/bitset/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    bitset
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/csl/string/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    string
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/csl/pair/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pair
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5_4" >
        
          
          <label class="md-nav__link" for="__nav_3_5_4" id="__nav_3_5_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    C++ 进阶
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_4">
            <span class="md-nav__icon md-icon"></span>
            C++ 进阶
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/class/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    类
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/namespace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    命名空间
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/value-category/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    值类别
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/op-overload/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    重载运算符
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    引用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/const/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    常值
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/new/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    新版 C++ 特性
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/lambda/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lambda 表达式
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/optimizations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    编译优化
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lang/cpp-other-langs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    C++ 与其他常用语言的区别
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../start/theory/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    理论环境配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../start/learn-more/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    资源聚集处
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../oj/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    OJ
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            OJ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../oj/ps1/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    第一学期
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            第一学期
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2_2" id="__nav_4_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    1-0
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_2">
            <span class="md-nav__icon md-icon"></span>
            1-0
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../oj/ps1/1-0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    讲义
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_3" >
        
          
          <label class="md-nav__link" for="__nav_4_2_3" id="__nav_4_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    1-1
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_3">
            <span class="md-nav__icon md-icon"></span>
            1-1
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../oj/ps1/1-1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    讲义
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../oj/ps1/1-1-sol/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    题解
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_4" >
        
          
          <label class="md-nav__link" for="__nav_4_2_4" id="__nav_4_2_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    1-2
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_4">
            <span class="md-nav__icon md-icon"></span>
            1-2
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../oj/ps1/1-2-sol/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    题解
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2_5" >
        
          
          <label class="md-nav__link" for="__nav_4_2_5" id="__nav_4_2_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    1-3
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2_5">
            <span class="md-nav__icon md-icon"></span>
            1-3
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../oj/ps1/1-3-sol/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    题解
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../lab/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Lab
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Lab
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#引入" class="md-nav__link">
    <span class="md-ellipsis">
      引入
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#任务描述" class="md-nav__link">
    <span class="md-ellipsis">
      任务描述
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#组件代理系统入门" class="md-nav__link">
    <span class="md-ellipsis">
      组件代理系统入门
    </span>
  </a>
  
    <nav class="md-nav" aria-label="组件代理系统入门">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#从-border_proxy-的定义开始" class="md-nav__link">
    <span class="md-ellipsis">
      从 border_proxy 的定义开始
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#组件代理装饰器模式" class="md-nav__link">
    <span class="md-ellipsis">
      组件代理：装饰器模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#如何给组件套壳代理链" class="md-nav__link">
    <span class="md-ellipsis">
      如何给组件「套壳」：代理链
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#牛刀小试x-边框" class="md-nav__link">
    <span class="md-ellipsis">
      牛刀小试："X" 边框
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#代理机制下的-area-处理" class="md-nav__link">
    <span class="md-ellipsis">
      代理机制下的 area 处理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#代理功能参数机制" class="md-nav__link">
    <span class="md-ellipsis">
      代理/功能参数机制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#实例学习tui_quit_proxy" class="md-nav__link">
    <span class="md-ellipsis">
      实例学习：tui_quit_proxy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#set_attrs-的庐山真面目" class="md-nav__link">
    <span class="md-ellipsis">
      set_attrs 的庐山真面目
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#原有边框代理实现" class="md-nav__link">
    <span class="md-ellipsis">
      原有边框代理实现
    </span>
  </a>
  
    <nav class="md-nav" aria-label="原有边框代理实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#构造函数" class="md-nav__link">
    <span class="md-ellipsis">
      构造函数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#边框显示" class="md-nav__link">
    <span class="md-ellipsis">
      边框显示
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#功能注册" class="md-nav__link">
    <span class="md-ellipsis">
      功能注册
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#退出按钮子组件" class="md-nav__link">
    <span class="md-ellipsis">
      退出按钮子组件
    </span>
  </a>
  
    <nav class="md-nav" aria-label="退出按钮子组件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#框架系统引入" class="md-nav__link">
    <span class="md-ellipsis">
      框架系统引入
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#任务一实现退出按钮组件类" class="md-nav__link">
    <span class="md-ellipsis">
      任务一：实现退出按钮组件类
    </span>
  </a>
  
    <nav class="md-nav" aria-label="任务一：实现退出按钮组件类">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#创建新组件类" class="md-nav__link">
    <span class="md-ellipsis">
      创建新组件类
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#实现退出按钮类" class="md-nav__link">
    <span class="md-ellipsis">
      实现退出按钮类
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#测试退出按钮类" class="md-nav__link">
    <span class="md-ellipsis">
      测试退出按钮类
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#任务二将退出按钮作为子组件添加到-border_proxy-中" class="md-nav__link">
    <span class="md-ellipsis">
      任务二：将退出按钮作为子组件添加到 border_proxy 中
    </span>
  </a>
  
    <nav class="md-nav" aria-label="任务二：将退出按钮作为子组件添加到 border_proxy 中">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#创建回收子组件" class="md-nav__link">
    <span class="md-ellipsis">
      创建/回收子组件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#管理子组件绘制" class="md-nav__link">
    <span class="md-ellipsis">
      管理子组件绘制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#管理子组件事件" class="md-nav__link">
    <span class="md-ellipsis">
      管理子组件事件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#测试子组件" class="md-nav__link">
    <span class="md-ellipsis">
      测试子组件
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#悬停识别" class="md-nav__link">
    <span class="md-ellipsis">
      悬停识别
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="第一阶段">第一阶段<a class="headerlink" href="#第一阶段" title="Permanent link">&para;</a></h1>
<h2 id="引入">引入<a class="headerlink" href="#引入" title="Permanent link">&para;</a></h2>
<p>在第零阶段中，你已经配置好了项目运行的必要环境并进行了测试。</p>
<p>现在我们来藉由实现一个小功能来了解框架代码的原理和实现。</p>
<h2 id="任务描述">任务描述<a class="headerlink" href="#任务描述" title="Permanent link">&para;</a></h2>
<p>本阶段的代码任务的目的是改进 <code>border_proxy</code> 类的功能（定义在 <code>minitui/*/proxies/</code> 中）。</p>
<p>具体来说，要达成如下效果：</p>
<ul>
<li>支持边框在所属组件被鼠标悬停于其上时/成为焦点组件时高亮。</li>
<li>支持在边框右上角添加一个退出按钮子组件。该组件显示为一个红色的 &#9600; (<code>\u25a0</code>) 符号，同样应在鼠标悬停在其上时高亮，并在被点击时使得其所在组件退出。</li>
</ul>
<p>实现示例视频如下：</p>
<video controls>
<source src="../../../pics/phase0.mp4" />
</video>

<p>当然，直接实现可能是比较困难的，因此我们把实现任务分成了四个子任务：</p>
<ul>
<li>任务一：实现退出按钮组件类，能够将退出按钮作为窗口组件创建，并能在点击时退出。</li>
<li>任务二：将退出按钮作为子组件添加到边框右上角，能够正确显示为红色方块（不需要高亮），并正确响应点击（在点击按钮时退出）。</li>
<li>任务三（选做）：实现检测鼠标悬停/成为焦点功能，并实现退出按钮的鼠标悬停高亮/边框的悬停和焦点高亮功能。同时把 <code>title</code> 的实现和 <code>exit_button</code> 进行调和。</li>
<li>任务四（选做）：改进 <code>border_proxy</code> 类对于功能参数的解析，能够通过功能参数来控制边框是否创建退出按钮/是否在鼠标悬停或成为焦点时高亮。</li>
</ul>
<p>当然，尽管做了如此分解，要完成第一阶段的代码任务，仅知道上一阶段介绍的内容是不够的，必须对代码框架有着更加深入的认识才行。</p>
<p>接下来我们就来讲讲。</p>
<h2 id="组件代理系统入门">组件代理系统入门<a class="headerlink" href="#组件代理系统入门" title="Permanent link">&para;</a></h2>
<h3 id="从-border_proxy-的定义开始">从 <code>border_proxy</code> 的定义开始<a class="headerlink" href="#从-border_proxy-的定义开始" title="Permanent link">&para;</a></h3>
<p>要改进 <code>border_proxy</code>（下称边框代理）类的实现，首先需要了解它原先的实现。</p>
<p>OK，让我们打开 <code>proxies/border_proxy.h</code>，看到：</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">tui_border_proxy</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">tui_widget_proxy</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">factory_reg</span><span class="p">(</span><span class="n">tui_border_proxy</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;border&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="n">tui_border_proxy</span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="p">());</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">tui_rect</span><span class="w"> </span><span class="nf">area_transform</span><span class="p">(</span><span class="n">tui_rect</span><span class="w"> </span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="p">());</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>我们可以看到，该类继承自……<code>tui_widget_proxy</code>，这是个啥类？</p>
<p>OK，认命了，我们接着看这个类的定义吧。</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:1"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">widget_proxy.h</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">tui_widget_proxy</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">tui_widget</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">factory_reg</span><span class="p">(</span><span class="n">tui_widget_proxy</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;PROXY&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">content</span><span class="p">;</span>
<span class="w">  </span><span class="n">tui_widget_proxy</span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="p">());</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">tui_rect</span><span class="w"> </span><span class="nf">area_transform</span><span class="p">(</span><span class="n">tui_rect</span><span class="w"> </span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="nf">on_event</span><span class="p">(</span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="nf">on_child_exit</span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">child</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="nf">proxy</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="o">~</span><span class="n">tui_widget_proxy</span><span class="p">();</span>
<span class="p">};</span>
</code></pre></div>
</div>
</div>
</div>
<p>总算有我们看得懂的东西了：这个类继承自 <code>tui_widget</code>，看来它也是一个组件派生类。</p>
<p>而 <code>tui_border_proxy</code> 继承了它，说明其是一个在这个组件派生类上实现的一个具体组件。</p>
<p>仔细看看还可以发现 <code>proxies/</code> 目录下的其他类都继承了 <code>tui_widget_proxy</code>。</p>
<p>这是一种<strong>多层继承</strong>的设计，<code>tui_widget_proxy</code> 既是具有 <code>tui_widget</code> 特征/接口的派生类，也是一系列二级派生类共同特征/接口的基类。</p>
<p>换句话说，<code>tui_widget_proxy</code> 本身代表的是一系列具体组件类，即 minitui 中的<strong>「组件代理」</strong>，而边框代理类 <code>tui_border_proxy</code> 则是组件代理类之一。</p>
<p>那么什么是组件代理呢？现在就来介绍 minitui 中组件代理的概念。</p>
<h3 id="组件代理装饰器模式">组件代理：装饰器模式<a class="headerlink" href="#组件代理装饰器模式" title="Permanent link">&para;</a></h3>
<p>设想一个会输出全空的组件，就像这样：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">tui_some_widget::draw</span><span class="p">(</span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">putchar</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>现在我们希望让它在边缘不输出空而输出 'X'，应该怎么做呢？</p>
<p>也许可以写出这样的代码：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">tui_some_widget::draw</span><span class="p">(</span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">area</span><span class="p">.</span><span class="n">height</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;X&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">area</span><span class="p">.</span><span class="n">width</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;X&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">putchar</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>此时我们发现，对于任意组件，如果我们需要在它的边缘输出 'X'，都可以用一个类似的模式：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">tui_some_widget::draw</span><span class="p">(</span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">area</span><span class="p">.</span><span class="n">height</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;X&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">area</span><span class="p">.</span><span class="n">width</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;X&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// 进行原来的画图工作</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<p>当需要为一个现有组件添加上 'X' 边框时，可以按照这个套路修改其 <code>draw()</code> 方法。但当需要为多个组件添加 'X' 边框时，这样做就需要为每个组件重新写一遍相同的逻辑，不仅麻烦而且不灵活。</p>
<p>有什么办法能够将这段边框逻辑抽取出来，封装到单个实体中呢？</p>
<p>这就是组件代理要做的事情。
每个具体的组件代理类都封装了一段这样的功能逻辑，从而使其实例能够将该逻辑应用到<em>被代理的</em>组件上。</p>
<p>现在我们就能够看懂组件代理基类的定义了：</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">tui_widget_proxy</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">tui_widget</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 注册此组件代理的“功能名”，后面我们会看到它的用处</span>
<span class="w">  </span><span class="n">factory_reg</span><span class="p">(</span><span class="n">tui_widget_proxy</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;PROXY&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">content</span><span class="p">;</span>
<span class="w">  </span><span class="n">tui_widget_proxy</span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="p">());</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">tui_rect</span><span class="w"> </span><span class="nf">area_transform</span><span class="p">(</span><span class="n">tui_rect</span><span class="w"> </span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="nf">on_event</span><span class="p">(</span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="nf">on_child_exit</span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">child</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="nf">proxy</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="o">~</span><span class="n">tui_widget_proxy</span><span class="p">();</span>
<span class="p">};</span>
</code></pre></div>
<p>首先，组件代理基类继承自组件类，也就是说它实现了组件的全部接口。</p>
<p>同时，它还具有一个 <code>tui_widget *</code> 类型的属性 <code>content</code>，这就是指向被代理组件的指针。</p>
<p>再看其构造函数，除了接受 <code>content</code> 指针外，其还能够接受一个字符串列表作为参数（列表）。</p>
<p>再来看看其重载的几个组件接口：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span>
<span class="nf">tui_widget_proxy::draw</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span>
<span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">draw</span><span class="p">(</span><span class="n">point</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">tui_event</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_widget_proxy::on_event</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">on_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_widget_proxy::proxy</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">content</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">tui_event</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_widget_proxy::on_child_exit</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">child</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">on_child_exit</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>可以看到，其接口实现就是调用其所代理组件的接口。</p>
<p>看到这里，你可能会问：这么实现有什么用？只是增加了一个中间层而已。</p>
<p>是时候回顾我们计算机科学的至理名言了：</p>
<div class="admonition quote">
<p class="admonition-title">一言</p>
<p>All problems in computer science can be solved by another level of indirection.<br/>
（计算机科学领域的所有问题都可以通过增加一个中间层解决）
<div style="text-align:right"> —— David Wheeler </div></p>
</div>
<p>因为我们能够在派生类中重载这个「中间层」的实现，事实上相当于我们能够在此层里拦截被代理组件的接口调用。</p>
<p>于是我们可以在调用被代理组件接口之前，之后进行一些处理，或者干脆不调用被代理组件接口而顶替掉这一调用。</p>
<p>因此，对应某具体功能的一个派生组件代理类的接口可以实现成这样：</p>
<div class="highlight"><pre><span></span><code><span class="k">auto</span><span class="w"> </span><span class="n">tui_widget_proxy</span><span class="o">::</span><span class="n">some_interface</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">some_condition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// do something before calling content widget</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">content_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">some_interface</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// do something after calling content widget</span>
<span class="w">    </span><span class="c1">// do something to the return value</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">content_res</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// do something else</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">what_i_want_to_return</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>这种方法叫做<a href="https://zh.wikipedia.org/zh-cn/%E9%92%A9%E5%AD%90%E7%BC%96%E7%A8%8B">钩子编程</a>。运用钩子，可以使我们灵活地监视/修改已实现的程序功能。</p>
<p>钩子被广泛运用在调试，benchmarking，重定义系统 API，甚至游戏外挂等恶意程序中。</p>
<p>在面向对象的设计模式中，这种方法还有一个名字，叫做「装饰器模式」，这一名字更强调这种方法利用的「对象套对象」的模式。外层的对象被叫做「装饰器对象」。</p>
<p>在 minitui 中，我们将这些钩取、代理了内部组件接口的对象叫做<strong>「组件代理」</strong>。</p>
<p>现在，只要在调用接口时用组件代理替代掉被代理组件，就可以在组件上添加对应的功能。</p>
<h3 id="如何给组件套壳代理链">如何给组件「套壳」：代理链<a class="headerlink" href="#如何给组件套壳代理链" title="Permanent link">&para;</a></h3>
<p>乍一看这个标题问的没啥意义：既然都已经有了代理类，直接新建一个代理对象，将被代理组件的指针传进去构造不就好了？然而这里还存在两个问题：</p>
<ul>
<li>如果原组件已经被注册到窗口上了，新的组件代理需要替换原组件在窗口树和窗口管理器中的位置。同时还需要转交原组件和外部系统有关的属性给组件代理，我们把这些属性称作<em>外部属性</em>。</li>
<li>在套完壳之后，外部系统在只有外层组件代理指针的情况，怎么访问内部组件信息呢？内部组件又怎么访问到外层代理的信息呢？</li>
</ul>
<p>对于第一个问题，我们已经在 <code>tui_widget_proxy</code> 的构造函数中实现了，具体细节这里不表。总之，它替换了窗口系统中原内层组件的位置（包括 <code>root</code>），同时将 <code>parent</code>、<code>children</code> 等外部属性转交给了外层代理。</p>
<p>为解决第二个问题，我们需要实现一个能从外部代理访问内部组件或反之的接口。</p>
<p>我们知道，每个代理都能够通过 <code>content</code> 来访问内层组件。但是由于我们处理组件时并不知道一个组件是不是一个代理组件（因为<a href="#具体组件归一化多态">多态</a>），所以我们需要在组件基类实现一个接口来判断，这就是 <code>proxy()</code> 接口。</p>
<p>我们来看基类对于此接口的实现：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// no proxy</span>
<span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_widget::proxy</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>再来对比 <code>tui_widget_proxy</code> 基类的实现：</p>
<div class="highlight"><pre><span></span><code><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_widget_proxy::proxy</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">content</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>可以发现只需要调用这个接口就可以判断组件是否是代理，且若是的话可以获取内部组件指针。</p>
<p>容易想到，有时候我们会进行组件代理的嵌套来加上多个功能，这在<a href="#第二个-minitui-程序增加功能">前面的例子</a>中同样体现了。</p>
<p>于是，组件代理的嵌套事实上形成了一个链表状结构，我们叫它<strong>代理链</strong>。</p>
<p>这个链以组件为元素，以最外层组件为头部，以最内层非代理组件为尾部，以 <code>proxy()</code> 接口作为 <code>next</code> 指针。它满足链表的性质：从头部元素开始的 <code>next</code> 挨个接上了每个元素，尾部元素的 <code>next</code> 是 <code>NULL</code>。</p>
<p>同时请记住，在引入组件代理系统之后，外部系统处理的组件指针就都是代理链的头部组件（即最外层组件）了。
而每个这样的组件代表的是一整条组件链而不是单个组件——至少在内部实现上是这样的。</p>
<p>不过在逻辑上，虽然链上可能有众多组件，但当调用最外层组件的某个接口时，代理链上的所有组件都会按顺序参与接口处理（这个顺序有时比较重要，使用 <a href="#set_attrs-的庐山真面目">set_attrs</a> 时会决定这一顺序），使得它们整体看起来就像<em>一个</em>普通的组件一样——这就是代理链整体要向外提供的抽象。</p>
<p>现在回到正题，当外部系统希望获取某组件（代理链，下面不再区分）的最内层组件时，可以通过在代理链上递归来实现。</p>
<p>minitui 实现了组件的 <code>proxy_penetrator</code> 接口来实现这一功能。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 返回代理链最内层组件</span>
<span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_widget::proxy_penetrator</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 还能往内走</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">proxy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">proxy</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">proxy_penetrator</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// 已经抵达末尾</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>进一步地，我们可以把部分外部系统对于组件外部属性的访问直接封装成接口，令其直接操作最内层组件的对应属性，这样可以做到<em>不需移交组件的外部属性给外层组件</em>。</p>
<p>例如 <code>updated</code>：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:1"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">widget.h</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">set_updated</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">proxy_penetrator</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">};</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">reset_updated</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">proxy_penetrator</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">};</span>
<span class="kt">bool</span><span class="w"> </span><span class="nf">get_updated</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">proxy_penetrator</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">updated</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<details class="tip" open="open">
<summary>批判性思考：所以到底为什么要转交外部属性？</summary>
<p>到这已经可以看出，将组件的外部属性交给外层代理组件的实现是不好的。</p>
<p>一个可能更好的实现方式是将其保留在最内层。因为随着外层代理的动态变化，外部属性需要反复在不同组件之间传递，比较麻烦而且容易出错。</p>
<p>最简单的例子是删除一个最外层代理，就需要将所有的外部属性转交给次外层的组件。</p>
<p>如果将所有外部属性全部保留在内部，只需要像对 <code>updated</code> 那样，封装获取外部属性的接口，并限制外部属性为私有，只从接口访问属性即可。</p>
<p>事已至此，我们还是来看看怎么为不良的设计擦屁股吧。</p>
</details>
<p>由于外部属性已经被转移到外部代理，内层组件在需要访问外部属性时也需要追溯到最外层代理。</p>
<p>因此，我们在组件中添加了 <code>unproxy</code> 属性，它会在组件被用于构造外层代理时自动指向外层代理。借此容易实现追溯到最外层代理的 <code>unproxy_penetrator()</code> 方法：</p>
<div class="highlight"><pre><span></span><code><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_widget::unproxy_penetrator</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">unproxy</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">unproxy</span><span class="o">-&gt;</span><span class="n">unproxy_penetrator</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>同理，可以将部分外部属性的访问直接封装成接口，来避免手动调用这个方法：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:1"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">widget.h</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="nf">get_parent</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">unproxy_penetrator</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">get_children</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">unproxy_penetrator</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="牛刀小试x-边框">牛刀小试："X" 边框<a class="headerlink" href="#牛刀小试x-边框" title="Permanent link">&para;</a></h3>
<p>现在我们再回顾刚刚说的 "X" 边框功能，可以这样将它封装为一个组件代理类：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 继承组件代理基类</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">tui_xborder_proxy</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">tui_widget_proxy</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 注册功能名为 &quot;xborder&quot;</span>
<span class="w">  </span><span class="n">factory_reg</span><span class="p">(</span><span class="n">tui_xborder_proxy</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;xborder&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="n">tui_xborder_proxy</span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="p">());</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">tui_xborder_proxy</span><span class="o">::</span><span class="n">tui_xborder_proxy</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">content</span><span class="p">,</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span>
<span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">tui_widget_proxy</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 大部分工作基类构造函数都已经做了</span>
<span class="w">  </span><span class="c1">// 这里的处理很复杂，详见下一个小部分</span>
<span class="w">  </span><span class="c1">// 需要注意边框组件需要比被代理组件大一圈</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">instaniated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 如果已经被注册显示，需要调用 `tui_adjust_widget` 更新一下 `full_map`</span>
<span class="w">    </span><span class="c1">// 注意最后一个 `false` 表示不递归改变嵌套的代理的 `area`</span>
<span class="w">    </span><span class="n">tui_adjust_widget</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">tui_rect</span><span class="p">(</span>
<span class="w">      </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span>
<span class="w">      </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">tail</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">),</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tui_rect</span><span class="p">(</span>
<span class="w">      </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span>
<span class="w">      </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">tail</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">tui_xborder_proxy</span><span class="o">::</span><span class="n">draw</span><span class="p">(</span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">area</span><span class="p">.</span><span class="n">height</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;X&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">area</span><span class="p">.</span><span class="n">width</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">putchar</span><span class="p">(</span><span class="sc">&#39;X&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// 注意相对位置改变</span>
<span class="w">  </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">draw</span><span class="p">(</span><span class="n">point</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<p>这样，我们就终于成功将 "X" 边框逻辑封装到 <code>tui_xborder_proxy</code> 中了。</p>
<p>要使用这个功能，只需引用我们为它注册的功能名即可：</p>
<div class="highlight"><pre><span></span><code><span class="k">auto</span><span class="w"> </span><span class="n">some_widget</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tui_some_widget</span><span class="p">(</span><span class="n">globel_rect</span><span class="p">);</span>
<span class="n">some_widget</span><span class="o">-&gt;</span><span class="n">set_attrs</span><span class="p">({</span><span class="s">&quot;xborder&quot;</span><span class="p">});</span>
</code></pre></div>
<h3 id="代理机制下的-area-处理">代理机制下的 <code>area</code> 处理<a class="headerlink" href="#代理机制下的-area-处理" title="Permanent link">&para;</a></h3>
<p>我们知道 <code>area</code> 表示的是组件占据的矩形区域。</p>
<p>在大部分情况下，代理的 <code>area</code> 是和被代理组件一样的，这也是 <code>tui_widget_proxy</code> 组件的默认处理方式。</p>
<p>但是，可以注意到上面代码有非常复杂的关于 <code>area</code> 的处理，这是为什么呢？</p>
<p>首先，边框需要比内部组件大一圈，因此 <code>tui_xborder_proxy</code> 对象的 <code>area</code> 必须比 <code>content</code> 指向对象的 <code>area</code> 大一圈。</p>
<p>其次，在内部组件已经注册显示的情况下，基类构造函数会首先把边框代理自己即 <code>this</code> 替换上去，此时 <code>instantiated</code> 为 <code>true</code>。</p>
<p>这时,改变自己的 <code>area</code> 会使得 <code>full_map</code> 出现不同步的情况（增长的一圈的 <code>full_map</code> 没改），需要调用 <code>tui_adjust_widget</code> 接口。</p>
<p>这个接口是怎么实现的呢？为什么加了个 <code>false</code> 参数？RTFSC，马上来看看源码吧：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span>
<span class="nf">tui_adjust_widget</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">widget</span><span class="p">,</span>
<span class="w">  </span><span class="n">tui_rect</span><span class="w"> </span><span class="n">area</span><span class="p">,</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">proxy_penetrate</span><span class="w"> </span><span class="c1">// 默认是 `true`</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Debug</span><span class="p">(</span><span class="s">&quot;Adjusting widget %p %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">widget</span><span class="p">,</span><span class="w"> </span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="w">  </span><span class="n">tui_assert</span><span class="p">(</span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">instaniated</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// 在 `full_map` 中清除掉这个组件</span>
<span class="w">  </span><span class="n">tui_update_full_map</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// 修改 `area`</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">area</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">proxy_penetrate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">reset_area</span><span class="p">(</span><span class="n">area</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">widget</span><span class="o">-&gt;</span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">area</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// 在 `full_map` 中增加上这个组件</span>
<span class="w">  </span><span class="n">tui_update_full_map</span><span class="p">(</span><span class="n">widget</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>注意到第三个参数为 <code>true</code> 的情况下会调用 <code>reset_area</code> 接口而不是直接修改 <code>area</code>，我们来看看这个接口的实现：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span>
<span class="nf">tui_widget::reset_area</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_rect</span><span class="w"> </span><span class="n">area</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 通知组件即将被修改 `area`</span>
<span class="w">  </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">on_area_change</span><span class="p">(</span><span class="n">area</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// 若有内部组件，先对内部组件应用同样**相对**幅度的 `area` 修改。</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">proxy</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">proxy</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">reset_area</span><span class="p">(</span>
<span class="w">      </span><span class="n">tui_rect</span><span class="p">(</span>
<span class="w">        </span><span class="n">area</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">proxy</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">head</span><span class="p">,</span>
<span class="w">        </span><span class="n">area</span><span class="p">.</span><span class="n">tail</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">proxy</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">tail</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">tail</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// 最终修改 `area`</span>
<span class="w">  </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">area</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>OK，现在我们终于懂了：</p>
<ul>
<li><code>reset_area</code> 的功能是修改一个组件的 <code>area</code>，同时将其代理链上的组件的 <code>area</code> 全部做对应修改。</li>
<li><code>tui_adjust_widget</code> 的功能是修改一个<strong>已注册</strong>的组件的 <code>area</code>，在 <code>proxy_penetrate</code> 为真的情况下，需要连着代理链一起修改，否则就只需要修改组件本身。</li>
<li>调用 <code>tui_adjust_widget</code> 的目的就是要调大作为已注册组件的边框代理的 <code>area</code>，但是显然我们不需要连着内部代理链一起修改，所以把第三个参数设为 <code>false</code>。</li>
</ul>
<details class="tip" open="open">
<summary>批判性思考：能不能避免这个特判</summary>
<p>这个特判看起来很不优雅，我们能不能避免它？</p>
<p>一个方案是增加一个 <code>set_area</code> 接口来接管对组件 <code>area</code> 的修改：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span>
<span class="nf">tui_widget::set_area</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_rect</span><span class="w"> </span><span class="n">area</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">penetrate</span><span class="o">=</span><span class="nb">false</span><span class="w"> </span><span class="c1">// 修改应用在组件本身还是整个组件链上</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 特判要不要更新 `full_map`</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">instaniated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 更新 `full_map` 的同时更新 `area`</span>
<span class="w">    </span><span class="n">tui_adjust_widget</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="n">penetrate</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 直接修改 `area`</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">penetrate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">reset_area</span><span class="p">(</span><span class="n">area</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 通知组件即将被修改 `area`</span>
<span class="w">      </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">on_area_change</span><span class="p">(</span><span class="n">area</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">area</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>现在的逻辑就变为：</p>
<ul>
<li><code>tui_widget::reset_area</code> 是个工具方法，负责把 <code>area</code> 的修改传导到组件链上，只有对组件链修改的时候才会被调用。</li>
<li><code>tui_adjust_widget</code> 针对的是被注册的组件的 <code>area</code> 改变，可以仅对组件本身修改，也可以针对整个组件链修改。只要组件是被注册的，它能够独立完成整个流程。</li>
<li><code>tui_widget::set_area</code> 是最外部的修改 <code>area</code> 入口，如果组件被注册就调用 <code>tui_adjust_widget</code>，否则就自己完成修改流程。</li>
</ul>
<p>现在，在 <code>tui_xborder_proxy</code> 的构造函数处就只需要调用 <code>set_area</code> 就行了。</p>
<p>虽然变得优雅了一点，但是整个逻辑还是相当的复杂，在下面我们接着讨论导致逻辑复杂的原因。</p>
</details>
<details class="tip" open="open">
<summary>批判性思考：<code>full_map</code> 的问题</summary>
<p>这里可以看出，导致这么蛋疼的原因是 <code>full_map</code> 机制：每当被注册的窗口改变区域的时候，都要重新维护 <code>full_map</code>。这就导致了上面描述的调整组件区域出现了需要判断 <code>instaniated</code> 属性而采用不同逻辑的特性。</p>
<p><code>full_map</code> 本质来说是对 <code>tui_look_widget()</code> 结果的缓存，在下一阶段代码中我们可能直接删除它。</p>
<p>在删除它以后，<code>tui_adjust_widget()</code> 就没有必要存在了，统一走 <code>set_area()</code> 或者直接调用 <code>reset_area</code> 和直接赋值即可。不过我们还是推荐使用前者，具体原因再见下一个小贴士。</p>
</details>
<details class="tip" open="open">
<summary>批判性思考：直接访问成员 vs 封装成员访问接口</summary>
<p>minitui 的框架代码中的所有类成员都是公开可访问的，并且大量存在直接访问对象成员的代码。</p>
<p>这样做其实是破坏了对象的抽象的——许多时候我们希望一个对象的成员在被访问时（读取/修改）时总是进行一些额外的操作，例如上面提到过的：</p>
<ul>
<li>我们希望在组件的 <code>updated</code> 被读取时，总是返回最内层真实组件的 <code>updated</code> 属性。</li>
<li>我们希望在组件的 <code>area</code> 被修改时，总会调用组件的 <code>on_area_change()</code> 接口。</li>
</ul>
<p>这个时候，将成员访问封装成接口就可以方便复用以及灵活调整这部分逻辑了。</p>
<p>可以发现，这个封装接口的过程也可说是一种增加中间层，我们计算机科学领域名言的含金量还在上升。</p>
</details>
<h3 id="代理功能参数机制">代理/功能参数机制<a class="headerlink" href="#代理功能参数机制" title="Permanent link">&para;</a></h3>
<p>在根据功能创建代理时，minitui 允许在功能名后添加参数。</p>
<p>例如<a href="#第二个-minitui-程序增加功能">第二个 minitui 程序</a>中用到的 <code>quit</code> 功能，其定义格式为 <code>quit CODE</code>，<code>CODE</code> 就是一个参数。具体来说，代理名后以空格分隔的每个词都是一个参数，所有参数组成参数列表 <code>args</code> 和被代理组件指针一起被传入代理的构造函数。</p>
<p>因此，minitui 的所有组件代理的构造函数参数格式统一为 <code>(tui_widget *content, std::vector&lt;tui_fmt&gt; args)</code>。再提一嘴，<code>tui_fmt</code> 只是一个字符串的包装。</p>
<h3 id="实例学习tui_quit_proxy">实例学习：<code>tui_quit_proxy</code><a class="headerlink" href="#实例学习tui_quit_proxy" title="Permanent link">&para;</a></h3>
<p>现在让我们继续看看 <code>quit</code> 功能的实现。</p>
<p>该功能定义格式为 <code>quit CODE</code>，能够让组件在接收到 <code>CODE</code> 参数对应的键码时退出。</p>
<p><code>quit</code> 功能是由 <code>tui_quit_proxy</code> 注册的，现在我们来看看它是如何实现该功能的：</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">tui_quit_proxy</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">tui_widget_proxy</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">factory_reg</span><span class="p">(</span><span class="n">tui_quit_proxy</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;quit&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">quit_key</span><span class="p">;</span>

<span class="w">  </span><span class="n">tui_quit_proxy</span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="n">tui_widget_proxy</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tui_assert</span><span class="p">(</span><span class="o">!</span><span class="n">args</span><span class="p">.</span><span class="n">empty</span><span class="p">());</span>
<span class="w">    </span><span class="c1">// 解析 `CODE` 参数</span>
<span class="w">    </span><span class="n">quit_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]());</span>
<span class="w">    </span><span class="n">args</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">tui_fmt</span><span class="p">(</span><span class="s">&quot;%d_QUIT_PROXY&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">quit_key</span><span class="p">)());</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="n">on_event</span><span class="p">(</span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tui_event</span><span class="o">*</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tui_event</span><span class="o">::</span><span class="n">exit_on_key</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="n">quit_key</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">on_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="o">~</span><span class="n">tui_quit_proxy</span><span class="p">()</span><span class="w"> </span><span class="p">{};</span>
<span class="p">};</span>
</code></pre></div>
<p>正好我没有（其实是懒得）将方法实现和类定义分离，我们可以直观看到它的接口实现。</p>
<p>可以看到：</p>
<ul>
<li><code>tui_quit_proxy</code> 额外增加了一个属性 <code>quit_key</code>，用于在代理对象中保存需要响应的键码。</li>
<li>在接收事件时调用 <code>tui_event::exit_on_key</code> 方法，该方法实现如下：
    <div class="highlight"><pre><span></span><code><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_event::exit_on_key</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">,</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">retcode</span><span class="w"> </span><span class="c1">// 默认为 0</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 如果是键码为 key 的键盘事件，就返回退出事件</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">check_key</span><span class="p">(</span><span class="n">key</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="n">event</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tui_event</span><span class="p">(</span>
<span class="w">      </span><span class="n">TUI_EXIT_EVENT</span><span class="p">,</span>
<span class="w">      </span><span class="k">new</span><span class="w"> </span><span class="n">tui_exit_event</span><span class="p">(</span><span class="n">retcode</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// 否则返回空</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"> </span>
<span class="p">}</span>
</code></pre></div>
    容易看到只需在 <code>res</code> 非空时直接返回 <code>res</code>（退出事件），否则调用 <code>content</code> 接口即可。</li>
<li>其他接口都不需要处理，直接调用被代理组件接口即可。</li>
</ul>
<h3 id="set_attrs-的庐山真面目"><code>set_attrs</code> 的庐山真面目<a class="headerlink" href="#set_attrs-的庐山真面目" title="Permanent link">&para;</a></h3>
<p>我们之前已经看到，可以通过调用组件的 <code>set_attrs()</code> 方法来在不改变组件实现的情况下为其添加功能。</p>
<p>事实上，到这里你应该可以猜到 <code>set_attrs()</code> 是通过组件代理机制实现的。</p>
<div class="highlight"><pre><span></span><code><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_widget::set_attrs</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">attrs</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">tui_proxy_factory</span><span class="o">::</span><span class="n">add</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">attrs</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>这里它接受一个 <code>tui_fmt</code>（即我们实现的格式化字符串）列表为参数，将自己和这个列表作为参数调用了 <code>tui_proxy_factory::add()</code> 函数。</p>
<p>顾名思义，这个函数是专门负责解析性质列表，然后按此给某个组件嵌套上代理组件的。</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:1"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">proxy_factory.h</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="nf">proxy_add</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">widget</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">proxy_name</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">proxy</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">proxy_create_list</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">proxy</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">proxy_name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">proxy</span><span class="p">.</span><span class="n">second</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">Warn</span><span class="p">(</span><span class="s">&quot;Proxy not found: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">proxy_name</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">widget</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="nf">add</span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">widget</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">attrs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">attrs</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">widget</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">widget</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">attr</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">attrs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// parse the proxy name in tui_fmt attr</span>
<span class="w">    </span><span class="n">tui_fmt</span><span class="w"> </span><span class="n">proxy_name</span><span class="p">(</span><span class="n">strtok</span><span class="p">(</span><span class="n">attr</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// parse the attributes in tui_fmt attr</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">curr_args</span><span class="p">{};</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">attr_str</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">attr_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strtok</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">curr_args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">tui_fmt</span><span class="p">(</span><span class="n">attr_str</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proxy_add</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">proxy_name</span><span class="p">(),</span><span class="w"> </span><span class="n">curr_args</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<p>观察这段代码，我们可以注意到：</p>
<ul>
<li>性质字符串以空格分割的第一个 token 是代理名称（用于索引代理），其后的 token 被装进列表作为参数传给代理组件的构造函数。</li>
<li>写在前面的性质转化成的代理会被嵌套在内层。</li>
<li>代理名和实际代理组件构造函数的映射关系被存在 <code>proxy_create_list</code> 中。</li>
</ul>
<p>这个 <code>proxy_create_list</code> 是怎么维护的呢？</p>
<p>具体原理比较复杂，我们直接讲如何把一个代理组件类的代理名-构造函数对注册入该表。</p>
<p>以 <code>tui_border_proxy</code> 为例，只需在类定义时添加：</p>
<div class="highlight"><pre><span></span><code><span class="n">factory_reg</span><span class="p">(</span><span class="n">tui_border_proxy</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;border&quot;</span><span class="p">);</span>
</code></pre></div>
<p>在类的实现文件 <code>*.cpp</code> 中添加：</p>
<div class="highlight"><pre><span></span><code><span class="n">factory_reg_impl</span><span class="p">(</span><span class="n">tui_border_proxy</span><span class="p">);</span>
</code></pre></div>
<p>这样就可以通过在 <code>set_attrs</code> 时传入 <code>"border [arg1 arg2 ...]"</code> 来为组件创建 <code>tui_border_proxy</code> 代理组件以实现边框性质了。</p>
<h2 id="原有边框代理实现">原有边框代理实现<a class="headerlink" href="#原有边框代理实现" title="Permanent link">&para;</a></h2>
<p>理解了组件代理系统之后，我们总算可以更细致地看看边框代理的原有实现了。</p>
<h3 id="构造函数">构造函数<a class="headerlink" href="#构造函数" title="Permanent link">&para;</a></h3>
<p>首先我们需要在构造函数中根据传入的参数初始化边框代理组件。</p>
<p>初始化逻辑和 <code>xborder</code> 是类似的，但是它还额外支持 <code>shrink</code> 参数，这么处理是方便在添加边框之后维持原有组件区域不变（让原有组件往内缩而不是在外面套一层）。</p>
<p>于是初始化逻辑是这样的：</p>
<ul>
<li>如果有 <code>shrink</code> 参数，则将被代理组件缩小一圈。</li>
<li>如果没有 <code>shrink</code> 参数，则和前面实现的 <code>xborder</code> 一样把自己扩大一圈。</li>
</ul>
<p>于是实现是这样的：</p>
<div class="highlight"><pre><span></span><code><span class="n">tui_border_proxy</span><span class="o">::</span><span class="n">tui_border_proxy</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">content</span><span class="p">,</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span>
<span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">tui_widget_proxy</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;shrink&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">reset_area</span><span class="p">(</span><span class="n">tui_rect</span><span class="p">(</span>
<span class="w">      </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span>
<span class="w">      </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">tail</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">instaniated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">tui_adjust_widget</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">tui_rect</span><span class="p">(</span>
<span class="w">        </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">tail</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="p">),</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tui_rect</span><span class="p">(</span>
<span class="w">        </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">head</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span>
<span class="w">        </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">tail</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">tui_assert</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">isvalid</span><span class="p">());</span>
<span class="w">  </span><span class="n">strcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;BORDER_PROXY&quot;</span><span class="p">);</span>
<span class="p">}</span><span class="w">    </span>
</code></pre></div>
<h3 id="边框显示">边框显示<a class="headerlink" href="#边框显示" title="Permanent link">&para;</a></h3>
<p>和 <code>xborder</code> 类似，不过我们可以根据边框的位置选用不同的 <a href="https://en.wikipedia.org/wiki/Box-drawing_characters">Box Drawing 字符</a>（也就是那些长得像「边框」的字符）：</p>
<div class="highlight"><pre><span></span><code><span class="kt">void</span>
<span class="nf">tui_border_proxy::draw</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span>
<span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">area</span><span class="p">.</span><span class="n">height</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">area</span><span class="p">.</span><span class="n">width</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 四个角</span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="n">box_drawing</span><span class="p">(</span>
<span class="w">        </span><span class="n">point</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span>
<span class="w">          </span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span>
<span class="w">            </span><span class="nl">BORDER_DOWN_AND_RIGHT</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">BORDER_DOWN_AND_LEFT</span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span>
<span class="w">            </span><span class="nl">BORDER_UP_AND_RIGHT</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">BORDER_UP_AND_LEFT</span>
<span class="w">      </span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 水平的两边缘</span>
<span class="w">      </span><span class="n">printf</span><span class="p">(</span><span class="n">box_drawing</span><span class="p">(</span><span class="n">BORDER_HORIZONTAL</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">point</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">area</span><span class="p">.</span><span class="n">width</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 垂直的两边缘</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="n">box_drawing</span><span class="p">(</span><span class="n">BORDER_VERTICAL</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 正常绘制（注意相对位置）</span>
<span class="w">    </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">draw</span><span class="p">(</span><span class="n">point</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<details class="example" open="open">
<summary>标题功能</summary>
<p>可以发现这个边框代理没有实现标题功能。</p>
<p>事实上，在第零阶段框架代码中标题功能是独立由 <code>tui_title_proxy</code> 实现的。</p>
<p>大家可以阅读其源码，看看它是如何实现边框功能的。</p>
</details>
<h3 id="功能注册">功能注册<a class="headerlink" href="#功能注册" title="Permanent link">&para;</a></h3>
<p>查看源码可以发现，边框代理注册功能名为 <code>border</code>。</p>
<p>因此，在 <code>set_attr()</code> 时可以通过给出 <code>"border"</code> 串来为组件添加该代理。</p>
<h2 id="退出按钮子组件">退出按钮子组件<a class="headerlink" href="#退出按钮子组件" title="Permanent link">&para;</a></h2>
<p>历经千辛万苦，看了无数行代码，我们总算能够启动本阶段的代码任务了。</p>
<p>我们将第一个实现的目标选定为实现退出按钮<strong>子组件</strong>。</p>
<h3 id="框架系统引入">框架系统引入<a class="headerlink" href="#框架系统引入" title="Permanent link">&para;</a></h3>
<p>什么是<em>子组件</em>呢？在这里我们将接触到一个组件代理系统之外的一个新组件系统：框架系统。</p>
<p>我们最早提到过，在 minitui 中，有两种组件——窗口组件和非窗口组件。</p>
<p>前者的 <code>instantiated</code> 属性为 <code>true</code>，并且在窗口树上有一个确定的位置。</p>
<p>在引入了组件代理系统之后，我们把每个窗口组件变为了一串代理链，只有链头——最外层的组件——是狭义上的窗口组件，而内层的组件则不再有窗口组件的所谓「外部属性」。</p>
<p>但是我们仍然将处于代理链上的所有组件视为广义上的窗口组件，因为调用外层窗口组件上接口时，代理链上的所有组件都会参与。某种意义上，它们都是同一个组件，只不过把接口实现拆分到核心和若干个「装饰器」中了。另外，它们的 <code>area</code> 都是用同一个坐标系下的坐标表示的——对于窗口组件，都是全局坐标系。</p>
<p>但是在 GUI 中，一个窗口的结构往往是复杂的，以下图为例，窗口中通常有标题栏、状态栏、侧边栏等子组件，还有若干子窗格组件。</p>
<p><img alt="" src="../../../pics/framework.png" /></p>
<p>因此，我们需要引入一个代理系统和窗口树之外的新的组件间层级关系——框架。</p>
<p>在框架系统中，每个窗口组件都可以是一个拥有一列子组件的框架（下称框架组件或框架），这些组件之于框架组件就好像窗口之于全局系统一样：框架组件需要像全局系统管理窗口一样管理它们的位置、显示和事件。</p>
<div class="admonition note">
<p class="admonition-title">子窗口 &amp; 子组件</p>
<p>在引入框架系统之后，我们要区分子窗口和子组件两个词。</p>
<p>前者表示窗口树上的父子关系，后者则表示框架系统中的包含关系。</p>
</div>
<p>同时，子组件的区域 <code>area</code> 也不再是由屏幕全局坐标系下的位置确定的了，而是由相对于框架组件左上角的局部坐标系确定的。</p>
<p>这样设计是因为对于子组件而言，在框架上的相对位置才是其自身的性质，而绝对位置则可能随着框架本身的移动而改变——如果用绝对位置，框架就要修改所有子组件的位置，这是非常麻烦的。</p>
<p>另外，框架在受到绘制请求的时候往往需要将绘制分发给子组件。对于绘制而言，使用相对位置显然是较为比较方便的（因为绘制请求的参数是一个相对位置）。</p>
<p>当然，框架还需要分发事件——但是除了鼠标事件外，其他事件大多是和坐标无关的。当然，鼠标事件一般是具有全局坐标的，这里就会产生<strong>全局坐标和相对坐标的转换问题</strong>，我们后面会实现它。</p>
<p>总体而言，针对框架子组件采用相对坐标表示位置是利大于弊的。</p>
<p>到这里你可能会觉得：靠！那实现框架岂不是要我把全局的窗口管理系统（绘制、事件）全部实现一遍吗？这样不仅麻烦，而且还没复用一丁点代码，太不优雅了吧！</p>
<p>别急，我们并不是要在框架中再实现一个 minitui——虽然理论上你也可以这么做——框架中的子组件之间的关系远远比窗口树来得简单，它们一般互不重叠，也没有需要传递事件的父子关系。</p>
<p>因此，大部分情况下，你只需要实现相当简单的绘制/事件分发机制：</p>
<p>在本阶段的任务中，情况更是简化到只有一个子组件——退出按钮组件。</p>
<p>它的大小是 <span class="arithmatex">\(1 \times 1\)</span>，我们只需要在框架中考虑是否需要将事件/绘制传递给它即可。</p>
<h3 id="任务一实现退出按钮组件类">任务一：实现退出按钮组件类<a class="headerlink" href="#任务一实现退出按钮组件类" title="Permanent link">&para;</a></h3>
<h4 id="创建新组件类">创建新组件类<a class="headerlink" href="#创建新组件类" title="Permanent link">&para;</a></h4>
<p>为了能把退出按钮作为一个子组件添加到边框右上角，首先需要能够创建退出按钮组件。</p>
<p>为支持这种组件的创建，我们需要实现一个新的组件类——退出按钮组件类。</p>
<p>如果你对实现一种新的具体组件毫无想法，建议复习一下<a href="#具体组件实现方式继承">这里</a>。</p>
<p>对于一个多模块（源/头文件）项目而言，新建一个模块（新的组件类就是这样一个新的模块）比较复杂，下面提供一些基本指导。</p>
<p>在新建组件类时，我们首先需要在 <code>include/widgets/</code> 目录下增加该组件类的定义头文件，如 <code>border_exit_button.h</code>，然后在 <code>minitui.h</code> 中增加对该头文件的引用（你可以参照对其他组件类定义头文件的引用格式！）。</p>
<p>我们给出一个定义的示例：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 这两行是为了防止头文件被直接或间接重复包含（即 `include` 时）时内部代码被重复编译</span>
<span class="c1">// 如果没定义 XX 宏，就定义该宏并编译代码，否则跳过编译</span>
<span class="c1">// 容易发现此时重复包含头文件内部代码也只会被编译一次</span>
<span class="cp">#ifndef BORDER_EXIT_BUTTON_H__</span>
<span class="cp">#define BORDER_EXIT_BUTTON_H__</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;minitui.h&gt;</span>

<span class="c1">// 继承自组件基类</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">tui_border_exit_button</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">tui_widget</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 组件只需要给一个位置就能确定区域（因为它的大小是一，只占据这个位置）</span>
<span class="w">  </span><span class="n">tui_border_exit_button</span><span class="p">(</span><span class="n">tui_point</span><span class="w"> </span><span class="n">location</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// 重载绘制接口</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="c1">// 重载事件接口</span>
<span class="w">  </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="nf">on_event</span><span class="p">(</span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// 是开头 #ifdef 语句的关闭语句</span>
<span class="cp">#endif</span>
</code></pre></div>
<p>同时，还需要在 <code>source/widgets/</code> 下创建该组件类的实现源文件，如 <code>border_exit_button.cpp</code>，其内部需要给出这个新组件类的各方法实现。</p>
<p>再给出一个实现源文件的示例：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;minitui.h&gt;</span>

<span class="c1">// 构造函数，直接根据 location 创建 area</span>
<span class="n">tui_border_exit_button</span><span class="o">::</span><span class="n">tui_border_exit_button</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_point</span><span class="w"> </span><span class="n">location</span>
<span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">tui_widget</span><span class="p">(</span><span class="n">tui_rect</span><span class="p">(</span><span class="n">location</span><span class="p">,</span><span class="w"> </span><span class="n">location</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">tui_border_exit_button</span><span class="o">::</span><span class="n">draw</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span>
<span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 设置成红色</span>
<span class="w">  </span><span class="c1">// tui_formatter 的第一个构造参数是前景色的 RGB 值，第二个是背景色的 RGB 值</span>
<span class="w">  </span><span class="c1">// 其他预定义的 RGB 值可以见 `formatter.h`</span>
<span class="w">  </span><span class="n">tui_formatter</span><span class="p">(</span>
<span class="w">    </span><span class="n">TUI_RED_V</span><span class="p">,</span>
<span class="w">    </span><span class="n">TUI_BLACK_V</span>
<span class="w">  </span><span class="p">).</span><span class="n">set</span><span class="p">();</span>
<span class="w">  </span><span class="c1">// 打印出方块字符</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\u25a0</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 事件响应接口</span>
<span class="n">tui_event</span><span class="w"> </span><span class="o">*</span>
<span class="n">tui_border_exit_button</span><span class="o">::</span><span class="n">on_event</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">event_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TUI_MOUSE_EVENT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 是鼠标事件</span>
<span class="w">    </span><span class="c1">// 获取鼠标事件体</span>
<span class="w">    </span><span class="n">tui_mouse_event</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mouse_event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tui_mouse_event</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">event</span><span class="o">-&gt;</span><span class="n">event_body</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// 是左击事件，而且是释放事件，表示点击已经结束</span>
<span class="w">    </span><span class="c1">// 鼠标事件类型请查看 `event.h` 中的 `tui_mouse_event_type` 枚举类</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mouse_event</span><span class="o">-&gt;</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mouse_event</span><span class="o">-&gt;</span><span class="n">ispress</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">??</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">      </span><span class="c1">// 我们接管该事件，回收它的空间</span>
<span class="w">      </span><span class="k">delete</span><span class="w"> </span><span class="n">event</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// 返回一个退出事件作为处理后的事件，告诉外部自己将退出</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tui_event</span><span class="p">(</span>
<span class="w">        </span><span class="n">TUI_EXIT_EVENT</span><span class="p">,</span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">tui_exit_event</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">delete</span><span class="w"> </span><span class="n">event</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="实现退出按钮类">实现退出按钮类<a class="headerlink" href="#实现退出按钮类" title="Permanent link">&para;</a></h4>
<p>因为这是第一个代码任务，为让大家尽快熟悉代码框架接口的使用方法，上面已经几乎给出了全部实现。不过，大家还是要仔细阅读代码——因为之后还要改。</p>
<p>首先我们说过按钮组件只有一格大，因此也只会被绘制一格，可以忽略绘制的 <code>point</code> 参数，直接打印出 <code>\u25a0</code> 方块即可。</p>
<p>不过还需要将方块颜色设置为红色，这需要我们调用转义序列将屏幕前景色设置为红色，背景色设置为黑色。<code>tui_formatter</code> 提供了这个功能面向对象式的封装和一系列预定义的 RGB 值，用法可以参照示例代码和 <code>formatter.h</code> 以及 <code>formatter.cpp</code>。</p>
<p>对于事件接口——我们只需要响应一种事件，即鼠标左击释放事件，在接收到这一事件时判断鼠标是否点击在按钮上——如果是，就返回退出事件传递关闭组件的信号。</p>
<p>还有一个好消息，在 minitui 默认实现中，叶子窗口（没有子窗口的窗口）只会接收到点击在其上的点击事件（因为点击事件会直接将焦点窗口移动到其点击位置的窗口，然后令事件系统将事件传给它）。</p>
<p>因此只要接收到左击释放事件，不需做坐标判断，直接退出即可。</p>
<h4 id="测试退出按钮类">测试退出按钮类<a class="headerlink" href="#测试退出按钮类" title="Permanent link">&para;</a></h4>
<p>在实现好退出按钮类之后，可以在 <code>main.cpp</code> 中创建它进行测试：</p>
<div class="highlight"><pre><span></span><code><span class="n">root</span><span class="o">-&gt;</span><span class="n">create_widget</span><span class="p">(</span>
<span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="n">tui_border_exit_button</span><span class="p">(</span>
<span class="w">    </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>
<p>重新编译启动游戏以后，首先你应该看到屏幕上出现了退出按钮组件——一个红方点。</p>
<p>然后用左键点击它，它应当在松开左键时退出且不影响主程序或其他窗口的正常运行。</p>
<p>你甚至可以给它加上可被方向键控制移动的功能，测试它在被移动时是否会出错：</p>
<div class="highlight"><pre><span></span><code><span class="n">root</span><span class="o">-&gt;</span><span class="n">create_widget</span><span class="p">(</span>
<span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="n">tui_border_exit_button</span><span class="p">(</span>
<span class="w">    </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>
<span class="p">)</span><span class="o">-&gt;</span><span class="n">set_attrs</span><span class="p">({</span><span class="s">&quot;kbd_move&quot;</span><span class="p">});</span>
</code></pre></div>
<p>不过在让它获取焦点的时候，注意使用右键点击——否则它会退出。或者把它作为最后一个加入的组件，这样程序刚启动的时候焦点就会在它身上。</p>
<p>如果到此一切顺利，那么这个代码任务就成功完成了，恭喜你完成了第一个代码任务！</p>
<details class="question" open="open">
<summary>怎么到这才完成一个任务……</summary>
<p>好的开始是成功的一半。</p>
<p>在框架上开发时，能够写出第一行代码的前提是看懂了代码框架的相关内容。</p>
<p>因此可以说，在介绍这个任务之前的代码框架介绍才是这份讲义的主要内容。</p>
<p>完成这个代码任务意味着你已经读完了前面的框架代码说明以及阅读了大量框架源代码。这为后续的代码任务做了至关重要的铺垫。</p>
<p>夸张的说，这个代码任务也许在功能上只走了一小步，但你对框架的掌握，以及整体的项目进度前进了一大步——也许已经有了一半之多。所以打起干劲，趁热打铁接着实现吧！</p>
</details>
<h3 id="任务二将退出按钮作为子组件添加到-border_proxy-中">任务二：将退出按钮作为子组件添加到 <code>border_proxy</code> 中<a class="headerlink" href="#任务二将退出按钮作为子组件添加到-border_proxy-中" title="Permanent link">&para;</a></h3>
<p>现在我们需要改进 <code>border_proxy</code> 的实现，使得其能够添加刚刚实现的退出按钮实例作为子组件。也许你会问：一个组件代理也可以作为框架拥有子组件吗？</p>
<p>答案是肯定的。毕竟我们说过，整个代理链上的所有组件在逻辑上是同一个组件。</p>
<p>因此，我们也可以在其中的任何一环增加子组件，在逻辑上，这些子组件属于整个代理链，而代理链整体可以作为一个框架。不过为了方便我们就令新建子组件的组件代理直接作为其框架组件了，并在轮到该组件代理接口被调用时处理子组件的相关接口。</p>
<h4 id="创建回收子组件">创建/回收子组件<a class="headerlink" href="#创建回收子组件" title="Permanent link">&para;</a></h4>
<p>OK，说了这么多，言归正传。</p>
<p>边框代理是一个比较特殊的代理，因为它将代理链的最外圈区域的绘制交给自己管理，因此可以认为它「占据」代理链构成的整体组件的最外圈区域。</p>
<p>因此，我们可以将这一边缘区域的右上角——具体来说，是 <code>(0, area.width() - 2)</code> 这个地方——分配给退出按钮。具体来说，在构造结束时创建这一按钮：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 当然，如果边框太窄就放弃创建它</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">width</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">exit_button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">  </span><span class="c1">// 我们说过，子组件用相对位置</span>
<span class="w">  </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">border_exit_button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">tui_border_exit_button</span><span class="p">(</span>
<span class="w">    </span><span class="n">tui_point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">.</span><span class="n">width</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>
<span class="w">  </span><span class="c1">// 将子组件的所属「框架」指针设为自己</span>
<span class="w">  </span><span class="n">border_exit_button</span><span class="o">-&gt;</span><span class="n">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">border_exit_button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n">exit_button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>记得在边框代理中创建一个 <code>exit_button</code> 属性表示退出按钮是否成功创建，以及一个 <code>border_exit_button</code> 指针属性来指向创建的子组件。</p>
<p>同时，还要在析构函数中在存在子组件的情况下销毁它：</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:1"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">border_proxy.cpp</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><pre><span></span><code><span class="n">tui_border_proxy</span><span class="o">::~</span><span class="n">tui_border_proxy</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">border_exit_button</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tui_widget</span><span class="o">::</span><span class="n">delete_widget</span><span class="p">(</span><span class="n">border_exit_button</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>这样修改之后的定义应该是这样的：</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">tui_border_proxy</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">tui_widget_proxy</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">exit_button</span><span class="p">;</span>
<span class="w">  </span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">border_exit_button</span><span class="p">;</span>

<span class="w">  </span><span class="n">factory_reg</span><span class="p">(</span><span class="n">tui_border_proxy</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;border&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="n">tui_border_proxy</span><span class="p">(</span><span class="n">tui_widget</span><span class="w"> </span><span class="o">*</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="p">());</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">tui_rect</span><span class="w"> </span><span class="nf">area_transform</span><span class="p">(</span><span class="n">tui_rect</span><span class="w"> </span><span class="n">area</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">tui_fmt</span><span class="o">&gt;</span><span class="p">());</span>

<span class="w">  </span><span class="o">~</span><span class="n">tui_border_proxy</span><span class="p">();</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<h4 id="管理子组件绘制">管理子组件绘制<a class="headerlink" href="#管理子组件绘制" title="Permanent link">&para;</a></h4>
<p>我们说过，框架要自己根据子组件信息（主要是其位置）管理子组件的绘制。</p>
<p>对于此时作为框架的边框代理，只需要在绘制时检查绘制的位置是否是放置退出按钮的位置即可，据此在 <code>draw</code> 方法开头添加：</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">on_exit_button</span><span class="p">(</span><span class="n">point</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">tui_assert</span><span class="p">(</span><span class="n">border_exit_button</span><span class="p">);</span>
<span class="w">  </span><span class="n">border_exit_button</span><span class="o">-&gt;</span><span class="n">draw</span><span class="p">(</span><span class="n">tui_point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">难度提升</p>
<p>现在开始我们不手把手地教你了——这个 <code>on_exit_button</code> 方法需要你自己来在 <code>tui_border_proxy</code> 定义中添加，并在源文件中实现。</p>
<p>至于如何去添加和实现这一方法，你需要参考之前看过和写过的代码来自行学习，这不难的——实在不行可以求助网络、AI 或他人（但不要抄袭！）。</p>
<p>如果有疑惑，请参照<a href="../../../start/#重要提醒">学会解决问题</a>一节。</p>
</div>
<div class="admonition tip">
<p class="admonition-title">提示</p>
<p>在实现 <code>on_exit_button</code> 时，注意判断 <code>exit_button</code> 是否为真，在它不为真的时候可以总返回 <code>false</code>。</p>
<p>另外，该方法需要是一个 <code>const</code> 成员方法——因为调用它的 <code>draw()</code> 方法也是 <code>const</code>。</p>
<p>至于怎么定义一个 <code>const</code> 方法，可以参考 <code>draw</code> 的定义。</p>
</div>
<p>实现好之后，重新编译运行程序，把 <code>main.cpp</code> 还原回测试退出按钮组件之前，你会看到和演示视频中一样，每个边框右上角都出现了红色退出按钮。</p>
<p><img alt="" src="../../../pics/proj-test-exit-button-1.png" /></p>
<h4 id="管理子组件事件">管理子组件事件<a class="headerlink" href="#管理子组件事件" title="Permanent link">&para;</a></h4>
<p>除了显示之外，退出按钮子组件的主要功能——左键点击时退出是通过事件机制实现的，因此我们需要正确地将点击事件转发给它。</p>
<p>这时由于管理事件转发的是我们自己，因此我们就需要判断鼠标事件到底是否点击在这个按钮上了。</p>
<p>OK，现在让我们开始实现。</p>
<p>注意到原有的边框代理没有事件处理功能，也就是说沿用的是基类 <code>on_event()</code> 实现，现在我们需要令它重载 <code>on_event()</code> 方法。</p>
<div class="admonition warning">
<p class="admonition-title">自力更生</p>
<p>我们这里还是不手把手地教你怎么添加重载方法了，请参考之前实现过的代码。</p>
</div>
<p>你可能会这么实现这个重载方法：</p>
<div class="highlight"><pre><span></span><code><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_border_proxy::on_event</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">event_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TUI_MOUSE_EVENT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">mouse_event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tui_mouse_event</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">event</span><span class="o">-&gt;</span><span class="n">event_body</span><span class="p">;</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mouse_event</span><span class="o">-&gt;</span><span class="n">get_point</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 判断是否点击在上面</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">on_exit_button</span><span class="p">(</span><span class="n">point</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 直接转发事件</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">border_exit_button</span><span class="o">-&gt;</span><span class="n">on_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// 屏蔽所有点在边框上的事件</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">on_border</span><span class="p">(</span><span class="n">point</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">delete</span><span class="w"> </span><span class="n">event</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">on_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>在看示例的过程中，你可以顺便实现一下 <code>on_border</code> 方法——判断一个<em>相对</em>坐标在不在边框上。</p>
<p>OK，现在要说的是这个代码是<em>错误的</em>，可以暂停在这想想是为什么。</p>
<p>如果能想出是为什么的话，说明你超出我们预期地理解了框架代码（真的）。</p>
<p>现在我们来揭晓答案——<code>tui_mouse_event::get_point()</code> 方法返回的是一个绝对坐标！</p>
<p>悬在我们头顶的达摩克里斯之剑落下了——我们最后还是要实现框架系统中的绝对-相对坐标转换。</p>
<p>我们已经为你在 <code>tui_widget</code> 接口中预留好了 <code>gbl_point_interpreter</code> 和 <code>gbl_point_mapper</code> 接口，前者接受一个绝对坐标，转换成该组件上的相对坐标，后者反之。</p>
<p>现在你需要在 <code>widget.cpp</code> 中实现它们：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// a global point, we need to convert it to local point</span>
<span class="n">tui_point</span>
<span class="nf">tui_widget::gbl_point_interpreter</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_point</span><span class="w"> </span><span class="n">point</span>
<span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Debug(&quot;current: %d %d&quot;, point.x, point.y);</span>
<span class="w">  </span><span class="c1">// task phase0: convert a global point to a local point according `frame`</span>
<span class="w">  </span><span class="c1">// 注意 `frame` 属于代理链外部属性，需要引用最外层组件</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_frame</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// a local point, we need to convert it to global point</span>
<span class="n">tui_point</span>
<span class="nf">tui_widget::gbl_point_mapper</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_point</span><span class="w"> </span><span class="n">local_point</span>
<span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// task phase0: convert a local point to a global point according `frame`</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_frame</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>提示一下：仍然采用递归的做法，以前面的函数为例，只需每次判断 <code>frame</code> 是否为空：</p>
<ul>
<li>如果是，那么此时组件的 <code>area</code> 已经是全局坐标，只需要调用 <code>position_interpreter</code> 直接将全局坐标转化为相对坐标即可（这个函数的实现就是让坐标减去 <code>area.head</code>）。</li>
<li>如果不是，那么首先先调用 <code>frame</code> 的 <code>gbl_point_interpreter</code> 把全局坐标转换为 <code>frame</code> 组件中的相对坐标，此时只需将框架的坐标转化为组件的坐标即可——还是调用 <code>position_interpreter</code> 就行，因为此时组件的 <code>area</code> 就是用框架坐标表示的。</li>
</ul>
<p>同理（不过有点不同），可以实现后面的函数。</p>
<p>实现好这俩函数之后，就可以修改一下刚刚的事件接口重载实现了：</p>
<div class="highlight"><pre><span></span><code><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span>
<span class="nf">tui_border_proxy::on_event</span><span class="p">(</span>
<span class="w">  </span><span class="n">tui_event</span><span class="w"> </span><span class="o">*</span><span class="n">event</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">event_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TUI_MOUSE_EVENT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">mouse_event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tui_mouse_event</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">event</span><span class="o">-&gt;</span><span class="n">event_body</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 转换成相对坐标</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">gbl_point_interpreter</span><span class="p">(</span><span class="n">mouse_event</span><span class="o">-&gt;</span><span class="n">get_point</span><span class="p">());</span>

<span class="w">    </span><span class="c1">// check exit button</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">on_exit_button</span><span class="p">(</span><span class="n">point</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">border_exit_button</span><span class="o">-&gt;</span><span class="n">on_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// block mouse event on border</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">on_border</span><span class="p">(</span><span class="n">point</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">delete</span><span class="w"> </span><span class="n">event</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">content</span><span class="o">-&gt;</span><span class="n">on_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="测试子组件">测试子组件<a class="headerlink" href="#测试子组件" title="Permanent link">&para;</a></h4>
<p>现在重新编译运行游戏，点击红色退出按钮就真的可以使得组件退出了。</p>
<p>注意把除了根组件的组件全部关闭之后会使得程序退出。</p>
<div class="admonition success">
<p class="admonition-title">少女祈祷中……</p>
<p>第一阶段的必做任务到此结束。喝口水休息一下吧。</p>
</div>
<div class="admonition info">
<p class="admonition-title">选做部分</p>
<p>以下内容是本阶段任务的选做部分。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">内容建设中</p>
<p>以下内容建设中。</p>
</div>
<h2 id="悬停识别">悬停识别<a class="headerlink" href="#悬停识别" title="Permanent link">&para;</a></h2>
<p>在增加了退出按钮子组件之后，接下来我们来实现它在鼠标悬停时高亮的功能。</p>
<p>在 minitui 中实现检测鼠标悬停功能，有两个前置要素：</p>
<ul>
<li>检测当前鼠标位置。</li>
<li></li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 Problem-Solving (2024) TA Team
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.indexes", "content.tooltips"], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="../../../javascripts/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
      
    
  </body>
</html>